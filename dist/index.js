var On=Object.defineProperty;var Fs=e=>{throw TypeError(e)};var Tn=(e,t,s)=>t in e?On(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s;var x=(e,t,s)=>Tn(e,typeof t!="symbol"?t+"":t,s),Yt=(e,t,s)=>t.has(e)||Fs("Cannot "+s);var h=(e,t,s)=>(Yt(e,t,"read from private field"),s?s.call(e):t.get(e)),A=(e,t,s)=>t.has(e)?Fs("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(e):t.set(e,s),y=(e,t,s,r)=>(Yt(e,t,"write to private field"),r?r.call(e,s):t.set(e,s),s),R=(e,t,s)=>(Yt(e,t,"access private method"),s);var Ws=(e,t,s,r)=>({set _(n){y(e,t,n,s)},get _(){return h(e,t,r)}});import{AsyncLocalStorage as An}from"node:async_hooks";import{execa as T}from"execa";import{randomUUID as ks,randomBytes as kn,createHash as En}from"node:crypto";import E from"node:fs";import U from"node:path";import Sn from"node:os";import{existsSync as jn,statSync as Rn,createReadStream as Bs}from"fs";import{join as Gs}from"path";import{versions as Cn}from"process";import{Readable as fs}from"stream";import{createServer as Pn}from"http";import{Http2ServerRequest as Mt}from"http2";import _n from"crypto";var Ks=(e,t,s)=>(r,n)=>{let a=-1;return o(0);async function o(i){if(i<=a)throw new Error("next() called multiple times");a=i;let c,d=!1,u;if(e[i]?(u=e[i][0][0],r.req.routeIndex=i):u=i===e.length&&n||void 0,u)try{c=await u(r,()=>o(i+1))}catch(p){if(p instanceof Error&&t)r.error=p,c=await t(p,r),d=!0;else throw p}else r.finalized===!1&&s&&(c=await s(r));return c&&(r.finalized===!1||d)&&(r.res=c),r}},Mn=Symbol(),In=async(e,t=Object.create(null))=>{const{all:s=!1,dot:r=!1}=t,a=(e instanceof jr?e.raw.headers:e.headers).get("Content-Type");return a!=null&&a.startsWith("multipart/form-data")||a!=null&&a.startsWith("application/x-www-form-urlencoded")?Dn(e,{all:s,dot:r}):{}};async function Dn(e,t){const s=await e.formData();return s?Nn(s,t):{}}function Nn(e,t){const s=Object.create(null);return e.forEach((r,n)=>{t.all||n.endsWith("[]")?Hn(s,n,r):s[n]=r}),t.dot&&Object.entries(s).forEach(([r,n])=>{r.includes(".")&&(Ln(s,r,n),delete s[r])}),s}var Hn=(e,t,s)=>{e[t]!==void 0?Array.isArray(e[t])?e[t].push(s):e[t]=[e[t],s]:t.endsWith("[]")?e[t]=[s]:e[t]=s},Ln=(e,t,s)=>{let r=e;const n=t.split(".");n.forEach((a,o)=>{o===n.length-1?r[a]=s:((!r[a]||typeof r[a]!="object"||Array.isArray(r[a])||r[a]instanceof File)&&(r[a]=Object.create(null)),r=r[a])})},Tr=e=>{const t=e.split("/");return t[0]===""&&t.shift(),t},$n=e=>{const{groups:t,path:s}=Un(e),r=Tr(s);return qn(r,t)},Un=e=>{const t=[];return e=e.replace(/\{[^}]+\}/g,(s,r)=>{const n=`@${r}`;return t.push([n,s]),n}),{groups:t,path:e}},qn=(e,t)=>{for(let s=t.length-1;s>=0;s--){const[r]=t[s];for(let n=e.length-1;n>=0;n--)if(e[n].includes(r)){e[n]=e[n].replace(r,t[s][1]);break}}return e},Rt={},Fn=(e,t)=>{if(e==="*")return"*";const s=e.match(/^\:([^\{\}]+)(?:\{(.+)\})?$/);if(s){const r=`${e}#${t}`;return Rt[r]||(s[2]?Rt[r]=t&&t[0]!==":"&&t[0]!=="*"?[r,s[1],new RegExp(`^${s[2]}(?=/${t})`)]:[e,s[1],new RegExp(`^${s[2]}$`)]:Rt[r]=[e,s[1],!0]),Rt[r]}return null},Es=(e,t)=>{try{return t(e)}catch{return e.replace(/(?:%[0-9A-Fa-f]{2})+/g,s=>{try{return t(s)}catch{return s}})}},Wn=e=>Es(e,decodeURI),Ar=e=>{const t=e.url,s=t.indexOf("/",t.indexOf(":")+4);let r=s;for(;r<t.length;r++){const n=t.charCodeAt(r);if(n===37){const a=t.indexOf("?",r),o=t.slice(s,a===-1?void 0:a);return Wn(o.includes("%25")?o.replace(/%25/g,"%2525"):o)}else if(n===63)break}return t.slice(s,r)},Bn=e=>{const t=Ar(e);return t.length>1&&t.at(-1)==="/"?t.slice(0,-1):t},Fe=(e,t,...s)=>(s.length&&(t=Fe(t,...s)),`${(e==null?void 0:e[0])==="/"?"":"/"}${e}${t==="/"?"":`${(e==null?void 0:e.at(-1))==="/"?"":"/"}${(t==null?void 0:t[0])==="/"?t.slice(1):t}`}`),kr=e=>{if(e.charCodeAt(e.length-1)!==63||!e.includes(":"))return null;const t=e.split("/"),s=[];let r="";return t.forEach(n=>{if(n!==""&&!/\:/.test(n))r+="/"+n;else if(/\:/.test(n))if(/\?/.test(n)){s.length===0&&r===""?s.push("/"):s.push(r);const a=n.replace("?","");r+="/"+a,s.push(r)}else r+="/"+n}),s.filter((n,a,o)=>o.indexOf(n)===a)},Zt=e=>/[%+]/.test(e)?(e.indexOf("+")!==-1&&(e=e.replace(/\+/g," ")),e.indexOf("%")!==-1?Es(e,Sr):e):e,Er=(e,t,s)=>{let r;if(!s&&t&&!/[%+]/.test(t)){let o=e.indexOf("?",8);if(o===-1)return;for(e.startsWith(t,o+1)||(o=e.indexOf(`&${t}`,o+1));o!==-1;){const i=e.charCodeAt(o+t.length+1);if(i===61){const c=o+t.length+2,d=e.indexOf("&",c);return Zt(e.slice(c,d===-1?void 0:d))}else if(i==38||isNaN(i))return"";o=e.indexOf(`&${t}`,o+1)}if(r=/[%+]/.test(e),!r)return}const n={};r??(r=/[%+]/.test(e));let a=e.indexOf("?",8);for(;a!==-1;){const o=e.indexOf("&",a+1);let i=e.indexOf("=",a);i>o&&o!==-1&&(i=-1);let c=e.slice(a+1,i===-1?o===-1?void 0:o:i);if(r&&(c=Zt(c)),a=o,c==="")continue;let d;i===-1?d="":(d=e.slice(i+1,o===-1?void 0:o),r&&(d=Zt(d))),s?(n[c]&&Array.isArray(n[c])||(n[c]=[]),n[c].push(d)):n[c]??(n[c]=d)}return t?n[t]:n},Gn=Er,Kn=(e,t)=>Er(e,t,!0),Sr=decodeURIComponent,zs=e=>Es(e,Sr),ze,Z,fe,Rr,Cr,ms,ge,gr,jr=(gr=class{constructor(e,t="/",s=[[]]){A(this,fe);x(this,"raw");A(this,ze);A(this,Z);x(this,"routeIndex",0);x(this,"path");x(this,"bodyCache",{});A(this,ge,e=>{const{bodyCache:t,raw:s}=this,r=t[e];if(r)return r;const n=Object.keys(t)[0];return n?t[n].then(a=>(n==="json"&&(a=JSON.stringify(a)),new Response(a)[e]())):t[e]=s[e]()});this.raw=e,this.path=t,y(this,Z,s),y(this,ze,{})}param(e){return e?R(this,fe,Rr).call(this,e):R(this,fe,Cr).call(this)}query(e){return Gn(this.url,e)}queries(e){return Kn(this.url,e)}header(e){if(e)return this.raw.headers.get(e)??void 0;const t={};return this.raw.headers.forEach((s,r)=>{t[r]=s}),t}async parseBody(e){var t;return(t=this.bodyCache).parsedBody??(t.parsedBody=await In(this,e))}json(){return h(this,ge).call(this,"text").then(e=>JSON.parse(e))}text(){return h(this,ge).call(this,"text")}arrayBuffer(){return h(this,ge).call(this,"arrayBuffer")}blob(){return h(this,ge).call(this,"blob")}formData(){return h(this,ge).call(this,"formData")}addValidatedData(e,t){h(this,ze)[e]=t}valid(e){return h(this,ze)[e]}get url(){return this.raw.url}get method(){return this.raw.method}get[Mn](){return h(this,Z)}get matchedRoutes(){return h(this,Z)[0].map(([[,e]])=>e)}get routePath(){return h(this,Z)[0].map(([[,e]])=>e)[this.routeIndex].path}},ze=new WeakMap,Z=new WeakMap,fe=new WeakSet,Rr=function(e){const t=h(this,Z)[0][this.routeIndex][1][e],s=R(this,fe,ms).call(this,t);return s&&/\%/.test(s)?zs(s):s},Cr=function(){const e={},t=Object.keys(h(this,Z)[0][this.routeIndex][1]);for(const s of t){const r=R(this,fe,ms).call(this,h(this,Z)[0][this.routeIndex][1][s]);r!==void 0&&(e[s]=/\%/.test(r)?zs(r):r)}return e},ms=function(e){return h(this,Z)[1]?h(this,Z)[1][e]:e},ge=new WeakMap,gr),Pr={Stringify:1},X=(e,t)=>{const s=new String(e);return s.isEscaped=!0,s.callbacks=t,s},zn=/[&<>'"]/,_r=async(e,t)=>{let s="";t||(t=[]);const r=await Promise.all(e);for(let n=r.length-1;s+=r[n],n--,!(n<0);n--){let a=r[n];typeof a=="object"&&t.push(...a.callbacks||[]);const o=a.isEscaped;if(a=await(typeof a=="object"?a.toString():a),typeof a=="object"&&t.push(...a.callbacks||[]),a.isEscaped??o)s+=a;else{const i=[s];Te(a,i),s=i[0]}}return X(s,t)},Te=(e,t)=>{const s=e.search(zn);if(s===-1){t[0]+=e;return}let r,n,a=0;for(n=s;n<e.length;n++){switch(e.charCodeAt(n)){case 34:r="&quot;";break;case 39:r="&#39;";break;case 38:r="&amp;";break;case 60:r="&lt;";break;case 62:r="&gt;";break;default:continue}t[0]+=e.substring(a,n)+r,a=n+1}t[0]+=e.substring(a,n)},Mr=e=>{const t=e.callbacks;if(!(t!=null&&t.length))return e;const s=[e],r={};return t.forEach(n=>n({phase:Pr.Stringify,buffer:s,context:r})),s[0]},Ir=async(e,t,s,r,n)=>{typeof e=="object"&&!(e instanceof String)&&(e instanceof Promise||(e=e.toString()),e instanceof Promise&&(e=await e));const a=e.callbacks;return a!=null&&a.length?(n?n[0]+=e:n=[e],Promise.all(a.map(i=>i({phase:t,buffer:n,context:r}))).then(i=>Promise.all(i.filter(Boolean).map(c=>Ir(c,t,!1,r,n))).then(()=>n[0]))):Promise.resolve(e)},Jn="text/plain; charset=UTF-8",es=(e,t)=>({"Content-Type":e,...t}),gt,xt,le,Je,ce,Q,wt,Qe,Xe,Ce,bt,vt,xe,We,xr,Qn=(xr=class{constructor(e,t){A(this,xe);A(this,gt);A(this,xt);x(this,"env",{});A(this,le);x(this,"finalized",!1);x(this,"error");A(this,Je);A(this,ce);A(this,Q);A(this,wt);A(this,Qe);A(this,Xe);A(this,Ce);A(this,bt);A(this,vt);x(this,"render",(...e)=>(h(this,Qe)??y(this,Qe,t=>this.html(t)),h(this,Qe).call(this,...e)));x(this,"setLayout",e=>y(this,wt,e));x(this,"getLayout",()=>h(this,wt));x(this,"setRenderer",e=>{y(this,Qe,e)});x(this,"header",(e,t,s)=>{this.finalized&&y(this,Q,new Response(h(this,Q).body,h(this,Q)));const r=h(this,Q)?h(this,Q).headers:h(this,Ce)??y(this,Ce,new Headers);t===void 0?r.delete(e):s!=null&&s.append?r.append(e,t):r.set(e,t)});x(this,"status",e=>{y(this,Je,e)});x(this,"set",(e,t)=>{h(this,le)??y(this,le,new Map),h(this,le).set(e,t)});x(this,"get",e=>h(this,le)?h(this,le).get(e):void 0);x(this,"newResponse",(...e)=>R(this,xe,We).call(this,...e));x(this,"body",(e,t,s)=>R(this,xe,We).call(this,e,t,s));x(this,"text",(e,t,s)=>!h(this,Ce)&&!h(this,Je)&&!t&&!s&&!this.finalized?new Response(e):R(this,xe,We).call(this,e,t,es(Jn,s)));x(this,"json",(e,t,s)=>R(this,xe,We).call(this,JSON.stringify(e),t,es("application/json",s)));x(this,"html",(e,t,s)=>{const r=n=>R(this,xe,We).call(this,n,t,es("text/html; charset=UTF-8",s));return typeof e=="object"?Ir(e,Pr.Stringify,!1,{}).then(r):r(e)});x(this,"redirect",(e,t)=>{const s=String(e);return this.header("Location",/[^\x00-\xFF]/.test(s)?encodeURI(s):s),this.newResponse(null,t??302)});x(this,"notFound",()=>(h(this,Xe)??y(this,Xe,()=>new Response),h(this,Xe).call(this,this)));y(this,gt,e),t&&(y(this,ce,t.executionCtx),this.env=t.env,y(this,Xe,t.notFoundHandler),y(this,vt,t.path),y(this,bt,t.matchResult))}get req(){return h(this,xt)??y(this,xt,new jr(h(this,gt),h(this,vt),h(this,bt))),h(this,xt)}get event(){if(h(this,ce)&&"respondWith"in h(this,ce))return h(this,ce);throw Error("This context has no FetchEvent")}get executionCtx(){if(h(this,ce))return h(this,ce);throw Error("This context has no ExecutionContext")}get res(){return h(this,Q)||y(this,Q,new Response(null,{headers:h(this,Ce)??y(this,Ce,new Headers)}))}set res(e){if(h(this,Q)&&e){e=new Response(e.body,e);for(const[t,s]of h(this,Q).headers.entries())if(t!=="content-type")if(t==="set-cookie"){const r=h(this,Q).headers.getSetCookie();e.headers.delete("set-cookie");for(const n of r)e.headers.append("set-cookie",n)}else e.headers.set(t,s)}y(this,Q,e),this.finalized=!0}get var(){return h(this,le)?Object.fromEntries(h(this,le)):{}}},gt=new WeakMap,xt=new WeakMap,le=new WeakMap,Je=new WeakMap,ce=new WeakMap,Q=new WeakMap,wt=new WeakMap,Qe=new WeakMap,Xe=new WeakMap,Ce=new WeakMap,bt=new WeakMap,vt=new WeakMap,xe=new WeakSet,We=function(e,t,s){const r=h(this,Q)?new Headers(h(this,Q).headers):h(this,Ce)??new Headers;if(typeof t=="object"&&"headers"in t){const a=t.headers instanceof Headers?t.headers:new Headers(t.headers);for(const[o,i]of a)o.toLowerCase()==="set-cookie"?r.append(o,i):r.set(o,i)}if(s)for(const[a,o]of Object.entries(s))if(typeof o=="string")r.set(a,o);else{r.delete(a);for(const i of o)r.append(a,i)}const n=typeof t=="number"?t:(t==null?void 0:t.status)??h(this,Je);return new Response(e,{status:n,headers:r})},xr),$="ALL",Xn="all",Vn=["get","post","put","delete","options","patch"],Dr="Can not add a route since the matcher is already built.",Nr=class extends Error{},Yn="__COMPOSED_HANDLER",Zn=e=>e.text("404 Not Found",404),Js=(e,t)=>{if("getResponse"in e){const s=e.getResponse();return t.newResponse(s.body,s)}return console.error(e),t.text("Internal Server Error",500)},ee,q,Hr,te,Ee,It,Dt,Ve,ea=(Ve=class{constructor(t={}){A(this,q);x(this,"get");x(this,"post");x(this,"put");x(this,"delete");x(this,"options");x(this,"patch");x(this,"all");x(this,"on");x(this,"use");x(this,"router");x(this,"getPath");x(this,"_basePath","/");A(this,ee,"/");x(this,"routes",[]);A(this,te,Zn);x(this,"errorHandler",Js);x(this,"onError",t=>(this.errorHandler=t,this));x(this,"notFound",t=>(y(this,te,t),this));x(this,"fetch",(t,...s)=>R(this,q,Dt).call(this,t,s[1],s[0],t.method));x(this,"request",(t,s,r,n)=>t instanceof Request?this.fetch(s?new Request(t,s):t,r,n):(t=t.toString(),this.fetch(new Request(/^https?:\/\//.test(t)?t:`http://localhost${Fe("/",t)}`,s),r,n)));x(this,"fire",()=>{addEventListener("fetch",t=>{t.respondWith(R(this,q,Dt).call(this,t.request,t,void 0,t.request.method))})});[...Vn,Xn].forEach(a=>{this[a]=(o,...i)=>(typeof o=="string"?y(this,ee,o):R(this,q,Ee).call(this,a,h(this,ee),o),i.forEach(c=>{R(this,q,Ee).call(this,a,h(this,ee),c)}),this)}),this.on=(a,o,...i)=>{for(const c of[o].flat()){y(this,ee,c);for(const d of[a].flat())i.map(u=>{R(this,q,Ee).call(this,d.toUpperCase(),h(this,ee),u)})}return this},this.use=(a,...o)=>(typeof a=="string"?y(this,ee,a):(y(this,ee,"*"),o.unshift(a)),o.forEach(i=>{R(this,q,Ee).call(this,$,h(this,ee),i)}),this);const{strict:r,...n}=t;Object.assign(this,n),this.getPath=r??!0?t.getPath??Ar:Bn}route(t,s){const r=this.basePath(t);return s.routes.map(n=>{var o;let a;s.errorHandler===Js?a=n.handler:(a=async(i,c)=>(await Ks([],s.errorHandler)(i,()=>n.handler(i,c))).res,a[Yn]=n.handler),R(o=r,q,Ee).call(o,n.method,n.path,a)}),this}basePath(t){const s=R(this,q,Hr).call(this);return s._basePath=Fe(this._basePath,t),s}mount(t,s,r){let n,a;r&&(typeof r=="function"?a=r:(a=r.optionHandler,r.replaceRequest===!1?n=c=>c:n=r.replaceRequest));const o=a?c=>{const d=a(c);return Array.isArray(d)?d:[d]}:c=>{let d;try{d=c.executionCtx}catch{}return[c.env,d]};n||(n=(()=>{const c=Fe(this._basePath,t),d=c==="/"?0:c.length;return u=>{const p=new URL(u.url);return p.pathname=p.pathname.slice(d)||"/",new Request(p,u)}})());const i=async(c,d)=>{const u=await s(n(c.req.raw),...o(c));if(u)return u;await d()};return R(this,q,Ee).call(this,$,Fe(t,"*"),i),this}},ee=new WeakMap,q=new WeakSet,Hr=function(){const t=new Ve({router:this.router,getPath:this.getPath});return t.errorHandler=this.errorHandler,y(t,te,h(this,te)),t.routes=this.routes,t},te=new WeakMap,Ee=function(t,s,r){t=t.toUpperCase(),s=Fe(this._basePath,s);const n={basePath:this._basePath,path:s,method:t,handler:r};this.router.add(t,s,[r,n]),this.routes.push(n)},It=function(t,s){if(t instanceof Error)return this.errorHandler(t,s);throw t},Dt=function(t,s,r,n){if(n==="HEAD")return(async()=>new Response(null,await R(this,q,Dt).call(this,t,s,r,"GET")))();const a=this.getPath(t,{env:r}),o=this.router.match(n,a),i=new Qn(t,{path:a,matchResult:o,env:r,executionCtx:s,notFoundHandler:h(this,te)});if(o[0].length===1){let d;try{d=o[0][0][0][0](i,async()=>{i.res=await h(this,te).call(this,i)})}catch(u){return R(this,q,It).call(this,u,i)}return d instanceof Promise?d.then(u=>u||(i.finalized?i.res:h(this,te).call(this,i))).catch(u=>R(this,q,It).call(this,u,i)):d??h(this,te).call(this,i)}const c=Ks(o[0],this.errorHandler,h(this,te));return(async()=>{try{const d=await c(i);if(!d.finalized)throw new Error("Context is not finalized. Did you forget to return a Response object or `await next()`?");return d.res}catch(d){return R(this,q,It).call(this,d,i)}})()},Ve),Lr=[];function ta(e,t){const s=this.buildAllMatchers(),r=((n,a)=>{const o=s[n]||s[$],i=o[2][a];if(i)return i;const c=a.match(o[0]);if(!c)return[[],Lr];const d=c.indexOf("",1);return[o[1][d],c]});return this.match=r,r(e,t)}var Bt="[^/]+",dt=".*",ut="(?:|/.*)",Be=Symbol(),sa=new Set(".\\+*[^]$()");function ra(e,t){return e.length===1?t.length===1?e<t?-1:1:-1:t.length===1||e===dt||e===ut?1:t===dt||t===ut?-1:e===Bt?1:t===Bt?-1:e.length===t.length?e<t?-1:1:t.length-e.length}var Pe,_e,se,He,na=(He=class{constructor(){A(this,Pe);A(this,_e);A(this,se,Object.create(null))}insert(t,s,r,n,a){if(t.length===0){if(h(this,Pe)!==void 0)throw Be;if(a)return;y(this,Pe,s);return}const[o,...i]=t,c=o==="*"?i.length===0?["","",dt]:["","",Bt]:o==="/*"?["","",ut]:o.match(/^\:([^\{\}]+)(?:\{(.+)\})?$/);let d;if(c){const u=c[1];let p=c[2]||Bt;if(u&&c[2]&&(p===".*"||(p=p.replace(/^\((?!\?:)(?=[^)]+\)$)/,"(?:"),/\((?!\?:)/.test(p))))throw Be;if(d=h(this,se)[p],!d){if(Object.keys(h(this,se)).some(f=>f!==dt&&f!==ut))throw Be;if(a)return;d=h(this,se)[p]=new He,u!==""&&y(d,_e,n.varIndex++)}!a&&u!==""&&r.push([u,h(d,_e)])}else if(d=h(this,se)[o],!d){if(Object.keys(h(this,se)).some(u=>u.length>1&&u!==dt&&u!==ut))throw Be;if(a)return;d=h(this,se)[o]=new He}d.insert(i,s,r,n,a)}buildRegExpStr(){const s=Object.keys(h(this,se)).sort(ra).map(r=>{const n=h(this,se)[r];return(typeof h(n,_e)=="number"?`(${r})@${h(n,_e)}`:sa.has(r)?`\\${r}`:r)+n.buildRegExpStr()});return typeof h(this,Pe)=="number"&&s.unshift(`#${h(this,Pe)}`),s.length===0?"":s.length===1?s[0]:"(?:"+s.join("|")+")"}},Pe=new WeakMap,_e=new WeakMap,se=new WeakMap,He),Jt,yt,wr,aa=(wr=class{constructor(){A(this,Jt,{varIndex:0});A(this,yt,new na)}insert(e,t,s){const r=[],n=[];for(let o=0;;){let i=!1;if(e=e.replace(/\{[^}]+\}/g,c=>{const d=`@\\${o}`;return n[o]=[d,c],o++,i=!0,d}),!i)break}const a=e.match(/(?::[^\/]+)|(?:\/\*$)|./g)||[];for(let o=n.length-1;o>=0;o--){const[i]=n[o];for(let c=a.length-1;c>=0;c--)if(a[c].indexOf(i)!==-1){a[c]=a[c].replace(i,n[o][1]);break}}return h(this,yt).insert(a,t,r,h(this,Jt),s),r}buildRegExp(){let e=h(this,yt).buildRegExpStr();if(e==="")return[/^$/,[],[]];let t=0;const s=[],r=[];return e=e.replace(/#(\d+)|@(\d+)|\.\*\$/g,(n,a,o)=>a!==void 0?(s[++t]=Number(a),"$()"):(o!==void 0&&(r[Number(o)]=++t),"")),[new RegExp(`^${e}`),s,r]}},Jt=new WeakMap,yt=new WeakMap,wr),oa=[/^$/,[],Object.create(null)],Nt=Object.create(null);function $r(e){return Nt[e]??(Nt[e]=new RegExp(e==="*"?"":`^${e.replace(/\/\*$|([.\\+*[^\]$()])/g,(t,s)=>s?`\\${s}`:"(?:|/.*)")}$`))}function ia(){Nt=Object.create(null)}function la(e){var d;const t=new aa,s=[];if(e.length===0)return oa;const r=e.map(u=>[!/\*|\/:/.test(u[0]),...u]).sort(([u,p],[f,m])=>u?1:f?-1:p.length-m.length),n=Object.create(null);for(let u=0,p=-1,f=r.length;u<f;u++){const[m,w,v]=r[u];m?n[w]=[v.map(([b])=>[b,Object.create(null)]),Lr]:p++;let g;try{g=t.insert(w,p,m)}catch(b){throw b===Be?new Nr(w):b}m||(s[p]=v.map(([b,O])=>{const S=Object.create(null);for(O-=1;O>=0;O--){const[k,P]=g[O];S[k]=P}return[b,S]}))}const[a,o,i]=t.buildRegExp();for(let u=0,p=s.length;u<p;u++)for(let f=0,m=s[u].length;f<m;f++){const w=(d=s[u][f])==null?void 0:d[1];if(!w)continue;const v=Object.keys(w);for(let g=0,b=v.length;g<b;g++)w[v[g]]=i[w[v[g]]]}const c=[];for(const u in o)c[u]=s[o[u]];return[a,c,n]}function Ue(e,t){if(e){for(const s of Object.keys(e).sort((r,n)=>n.length-r.length))if($r(s).test(t))return[...e[s]]}}var we,be,Qt,Ur,br,ca=(br=class{constructor(){A(this,Qt);x(this,"name","RegExpRouter");A(this,we);A(this,be);x(this,"match",ta);y(this,we,{[$]:Object.create(null)}),y(this,be,{[$]:Object.create(null)})}add(e,t,s){var i;const r=h(this,we),n=h(this,be);if(!r||!n)throw new Error(Dr);r[e]||[r,n].forEach(c=>{c[e]=Object.create(null),Object.keys(c[$]).forEach(d=>{c[e][d]=[...c[$][d]]})}),t==="/*"&&(t="*");const a=(t.match(/\/:/g)||[]).length;if(/\*$/.test(t)){const c=$r(t);e===$?Object.keys(r).forEach(d=>{var u;(u=r[d])[t]||(u[t]=Ue(r[d],t)||Ue(r[$],t)||[])}):(i=r[e])[t]||(i[t]=Ue(r[e],t)||Ue(r[$],t)||[]),Object.keys(r).forEach(d=>{(e===$||e===d)&&Object.keys(r[d]).forEach(u=>{c.test(u)&&r[d][u].push([s,a])})}),Object.keys(n).forEach(d=>{(e===$||e===d)&&Object.keys(n[d]).forEach(u=>c.test(u)&&n[d][u].push([s,a]))});return}const o=kr(t)||[t];for(let c=0,d=o.length;c<d;c++){const u=o[c];Object.keys(n).forEach(p=>{var f;(e===$||e===p)&&((f=n[p])[u]||(f[u]=[...Ue(r[p],u)||Ue(r[$],u)||[]]),n[p][u].push([s,a-d+c+1]))})}}buildAllMatchers(){const e=Object.create(null);return Object.keys(h(this,be)).concat(Object.keys(h(this,we))).forEach(t=>{e[t]||(e[t]=R(this,Qt,Ur).call(this,t))}),y(this,we,y(this,be,void 0)),ia(),e}},we=new WeakMap,be=new WeakMap,Qt=new WeakSet,Ur=function(e){const t=[];let s=e===$;return[h(this,we),h(this,be)].forEach(r=>{const n=r[e]?Object.keys(r[e]).map(a=>[a,r[e][a]]):[];n.length!==0?(s||(s=!0),t.push(...n)):e!==$&&t.push(...Object.keys(r[$]).map(a=>[a,r[$][a]]))}),s?la(t):null},br),ve,de,vr,da=(vr=class{constructor(e){x(this,"name","SmartRouter");A(this,ve,[]);A(this,de,[]);y(this,ve,e.routers)}add(e,t,s){if(!h(this,de))throw new Error(Dr);h(this,de).push([e,t,s])}match(e,t){if(!h(this,de))throw new Error("Fatal error");const s=h(this,ve),r=h(this,de),n=s.length;let a=0,o;for(;a<n;a++){const i=s[a];try{for(let c=0,d=r.length;c<d;c++)i.add(...r[c]);o=i.match(e,t)}catch(c){if(c instanceof Nr)continue;throw c}this.match=i.match.bind(i),y(this,ve,[i]),y(this,de,void 0);break}if(a===n)throw new Error("Fatal error");return this.name=`SmartRouter + ${this.activeRouter.name}`,o}get activeRouter(){if(h(this,de)||h(this,ve).length!==1)throw new Error("No active router has been determined yet.");return h(this,ve)[0]}},ve=new WeakMap,de=new WeakMap,vr),lt=Object.create(null),ye,K,Me,Ye,W,ue,Se,Ze,ua=(Ze=class{constructor(t,s,r){A(this,ue);A(this,ye);A(this,K);A(this,Me);A(this,Ye,0);A(this,W,lt);if(y(this,K,r||Object.create(null)),y(this,ye,[]),t&&s){const n=Object.create(null);n[t]={handler:s,possibleKeys:[],score:0},y(this,ye,[n])}y(this,Me,[])}insert(t,s,r){y(this,Ye,++Ws(this,Ye)._);let n=this;const a=$n(s),o=[];for(let i=0,c=a.length;i<c;i++){const d=a[i],u=a[i+1],p=Fn(d,u),f=Array.isArray(p)?p[0]:d;if(f in h(n,K)){n=h(n,K)[f],p&&o.push(p[1]);continue}h(n,K)[f]=new Ze,p&&(h(n,Me).push(p),o.push(p[1])),n=h(n,K)[f]}return h(n,ye).push({[t]:{handler:r,possibleKeys:o.filter((i,c,d)=>d.indexOf(i)===c),score:h(this,Ye)}}),n}search(t,s){var c;const r=[];y(this,W,lt);let a=[this];const o=Tr(s),i=[];for(let d=0,u=o.length;d<u;d++){const p=o[d],f=d===u-1,m=[];for(let w=0,v=a.length;w<v;w++){const g=a[w],b=h(g,K)[p];b&&(y(b,W,h(g,W)),f?(h(b,K)["*"]&&r.push(...R(this,ue,Se).call(this,h(b,K)["*"],t,h(g,W))),r.push(...R(this,ue,Se).call(this,b,t,h(g,W)))):m.push(b));for(let O=0,S=h(g,Me).length;O<S;O++){const k=h(g,Me)[O],P=h(g,W)===lt?{}:{...h(g,W)};if(k==="*"){const F=h(g,K)["*"];F&&(r.push(...R(this,ue,Se).call(this,F,t,h(g,W))),y(F,W,P),m.push(F));continue}const[z,C,N]=k;if(!p&&!(N instanceof RegExp))continue;const j=h(g,K)[z],Le=o.slice(d).join("/");if(N instanceof RegExp){const F=N.exec(Le);if(F){if(P[C]=F[0],r.push(...R(this,ue,Se).call(this,j,t,h(g,W),P)),Object.keys(h(j,K)).length){y(j,W,P);const ke=((c=F[0].match(/\//))==null?void 0:c.length)??0;(i[ke]||(i[ke]=[])).push(j)}continue}}(N===!0||N.test(p))&&(P[C]=p,f?(r.push(...R(this,ue,Se).call(this,j,t,P,h(g,W))),h(j,K)["*"]&&r.push(...R(this,ue,Se).call(this,h(j,K)["*"],t,P,h(g,W)))):(y(j,W,P),m.push(j)))}}a=m.concat(i.shift()??[])}return r.length>1&&r.sort((d,u)=>d.score-u.score),[r.map(({handler:d,params:u})=>[d,u])]}},ye=new WeakMap,K=new WeakMap,Me=new WeakMap,Ye=new WeakMap,W=new WeakMap,ue=new WeakSet,Se=function(t,s,r,n){const a=[];for(let o=0,i=h(t,ye).length;o<i;o++){const c=h(t,ye)[o],d=c[s]||c[$],u={};if(d!==void 0&&(d.params=Object.create(null),a.push(d),r!==lt||n&&n!==lt))for(let p=0,f=d.possibleKeys.length;p<f;p++){const m=d.possibleKeys[p],w=u[d.score];d.params[m]=n!=null&&n[m]&&!w?n[m]:r[m]??(n==null?void 0:n[m]),u[d.score]=!0}}return a},Ze),Ie,yr,ha=(yr=class{constructor(){x(this,"name","TrieRouter");A(this,Ie);y(this,Ie,new ua)}add(e,t,s){const r=kr(t);if(r){for(let n=0,a=r.length;n<a;n++)h(this,Ie).insert(e,r[n],s);return}h(this,Ie).insert(e,t,s)}match(e,t){return h(this,Ie).search(e,t)}},Ie=new WeakMap,yr),Ae=class extends ea{constructor(e={}){super(e),this.router=e.router??new da({routers:[new ca,new ha]})}},Ss=(e,...t)=>{const s=[""];for(let r=0,n=e.length-1;r<n;r++){s[0]+=e[r];const a=Array.isArray(t[r])?t[r].flat(1/0):[t[r]];for(let o=0,i=a.length;o<i;o++){const c=a[o];if(typeof c=="string")Te(c,s);else if(typeof c=="number")s[0]+=c;else{if(typeof c=="boolean"||c===null||c===void 0)continue;if(typeof c=="object"&&c.isEscaped)if(c.callbacks)s.unshift("",c);else{const d=c.toString();d instanceof Promise?s.unshift("",d):s[0]+=d}else c instanceof Promise?s.unshift("",c):Te(c.toString(),s)}}}return s[0]+=e.at(-1),s.length===1?"callbacks"in s?X(Mr(X(s[0],s.callbacks))):X(s[0]):_r(s,s.callbacks)},js=Symbol("RENDERER"),gs=Symbol("ERROR_HANDLER"),H=Symbol("STASH"),qr=Symbol("INTERNAL"),pa=Symbol("MEMO"),Gt=Symbol("PERMALINK"),Qs=e=>(e[qr]=!0,e),Fr=e=>({value:t,children:s})=>{if(!s)return;const r={children:[{tag:Qs(()=>{e.push(t)}),props:{}}]};Array.isArray(s)?r.children.push(...s.flat()):r.children.push(s),r.children.push({tag:Qs(()=>{e.pop()}),props:{}});const n={tag:"",props:r,type:""};return n[gs]=a=>{throw e.pop(),a},n},Wr=e=>{const t=[e],s=Fr(t);return s.values=t,s.Provider=s,tt.push(s),s},tt=[],Rs=e=>{const t=[e],s=(r=>{t.push(r.value);let n;try{n=r.children?(Array.isArray(r.children)?new zr("",{},r.children):r.children).toString():""}finally{t.pop()}return n instanceof Promise?n.then(a=>X(a,a.callbacks)):X(n)});return s.values=t,s.Provider=s,s[js]=Fr(t),tt.push(s),s},at=e=>e.values.at(-1),Ht={title:[],script:["src"],style:["data-href"],link:["href"],meta:["name","httpEquiv","charset","itemProp"]},xs={},Lt="data-precedence",Tt=e=>Array.isArray(e)?e:[e],Xs=new WeakMap,Vs=(e,t,s,r)=>({buffer:n,context:a})=>{if(!n)return;const o=Xs.get(a)||{};Xs.set(a,o);const i=o[e]||(o[e]=[]);let c=!1;const d=Ht[e];if(d.length>0){e:for(const[,u]of i)for(const p of d)if(((u==null?void 0:u[p])??null)===(s==null?void 0:s[p])){c=!0;break e}}if(c?n[0]=n[0].replaceAll(t,""):d.length>0?i.push([t,s,r]):i.unshift([t,s,r]),n[0].indexOf("</head>")!==-1){let u;if(r===void 0)u=i.map(([p])=>p);else{const p=[];u=i.map(([f,,m])=>{let w=p.indexOf(m);return w===-1&&(p.push(m),w=p.length-1),[f,w]}).sort((f,m)=>f[1]-m[1]).map(([f])=>f)}u.forEach(p=>{n[0]=n[0].replaceAll(p,"")}),n[0]=n[0].replace(/(?=<\/head>)/,u.join(""))}},At=(e,t,s)=>X(new re(e,s,Tt(t??[])).toString()),kt=(e,t,s,r)=>{if("itemProp"in s)return At(e,t,s);let{precedence:n,blocking:a,...o}=s;n=r?n??"":void 0,r&&(o[Lt]=n);const i=new re(e,o,Tt(t||[])).toString();return i instanceof Promise?i.then(c=>X(i,[...c.callbacks||[],Vs(e,c,o,n)])):X(i,[Vs(e,i,o,n)])},fa=({children:e,...t})=>{const s=Cs();if(s){const r=at(s);if(r==="svg"||r==="head")return new re("title",t,Tt(e??[]))}return kt("title",e,t,!1)},ma=({children:e,...t})=>{const s=Cs();return["src","async"].some(r=>!t[r])||s&&at(s)==="head"?At("script",e,t):kt("script",e,t,!1)},ga=({children:e,...t})=>["href","precedence"].every(s=>s in t)?(t["data-href"]=t.href,delete t.href,kt("style",e,t,!0)):At("style",e,t),xa=({children:e,...t})=>["onLoad","onError"].some(s=>s in t)||t.rel==="stylesheet"&&(!("precedence"in t)||"disabled"in t)?At("link",e,t):kt("link",e,t,"precedence"in t),wa=({children:e,...t})=>{const s=Cs();return s&&at(s)==="head"?At("meta",e,t):kt("meta",e,t,!1)},Br=(e,{children:t,...s})=>new re(e,s,Tt(t??[])),ba=e=>(typeof e.action=="function"&&(e.action=Gt in e.action?e.action[Gt]:void 0),Br("form",e)),Gr=(e,t)=>(typeof t.formAction=="function"&&(t.formAction=Gt in t.formAction?t.formAction[Gt]:void 0),Br(e,t)),va=e=>Gr("input",e),ya=e=>Gr("button",e);const ts=Object.freeze(Object.defineProperty({__proto__:null,button:ya,form:ba,input:va,link:xa,meta:wa,script:ma,style:ga,title:fa},Symbol.toStringTag,{value:"Module"}));var Oa=new Map([["className","class"],["htmlFor","for"],["crossOrigin","crossorigin"],["httpEquiv","http-equiv"],["itemProp","itemprop"],["fetchPriority","fetchpriority"],["noModule","nomodule"],["formAction","formaction"]]),Kt=e=>Oa.get(e)||e,Kr=(e,t)=>{for(const[s,r]of Object.entries(e)){const n=s[0]==="-"||!/[A-Z]/.test(s)?s:s.replace(/[A-Z]/g,a=>`-${a.toLowerCase()}`);t(n,r==null?null:typeof r=="number"?n.match(/^(?:a|border-im|column(?:-c|s)|flex(?:$|-[^b])|grid-(?:ar|[^a])|font-w|li|or|sca|st|ta|wido|z)|ty$/)?`${r}`:`${r}px`:r)}},ht=void 0,Cs=()=>ht,Ta=e=>/[A-Z]/.test(e)&&e.match(/^(?:al|basel|clip(?:Path|Rule)$|co|do|fill|fl|fo|gl|let|lig|i|marker[EMS]|o|pai|pointe|sh|st[or]|text[^L]|tr|u|ve|w)/)?e.replace(/([A-Z])/g,"-$1").toLowerCase():e,Aa=["area","base","br","col","embed","hr","img","input","keygen","link","meta","param","source","track","wbr"],ka=["allowfullscreen","async","autofocus","autoplay","checked","controls","default","defer","disabled","download","formnovalidate","hidden","inert","ismap","itemscope","loop","multiple","muted","nomodule","novalidate","open","playsinline","readonly","required","reversed","selected"],Ps=(e,t)=>{for(let s=0,r=e.length;s<r;s++){const n=e[s];if(typeof n=="string")Te(n,t);else{if(typeof n=="boolean"||n===null||n===void 0)continue;n instanceof re?n.toStringToBuffer(t):typeof n=="number"||n.isEscaped?t[0]+=n:n instanceof Promise?t.unshift("",n):Ps(n,t)}}},re=class{constructor(e,t,s){x(this,"tag");x(this,"props");x(this,"key");x(this,"children");x(this,"isEscaped",!0);x(this,"localContexts");this.tag=e,this.props=t,this.children=s}get type(){return this.tag}get ref(){return this.props.ref||null}toString(){var t,s;const e=[""];(t=this.localContexts)==null||t.forEach(([r,n])=>{r.values.push(n)});try{this.toStringToBuffer(e)}finally{(s=this.localContexts)==null||s.forEach(([r])=>{r.values.pop()})}return e.length===1?"callbacks"in e?Mr(X(e[0],e.callbacks)).toString():e[0]:_r(e,e.callbacks)}toStringToBuffer(e){const t=this.tag,s=this.props;let{children:r}=this;e[0]+=`<${t}`;const n=ht&&at(ht)==="svg"?a=>Ta(Kt(a)):a=>Kt(a);for(let[a,o]of Object.entries(s))if(a=n(a),a!=="children"){if(a==="style"&&typeof o=="object"){let i="";Kr(o,(c,d)=>{d!=null&&(i+=`${i?";":""}${c}:${d}`)}),e[0]+=' style="',Te(i,e),e[0]+='"'}else if(typeof o=="string")e[0]+=` ${a}="`,Te(o,e),e[0]+='"';else if(o!=null)if(typeof o=="number"||o.isEscaped)e[0]+=` ${a}="${o}"`;else if(typeof o=="boolean"&&ka.includes(a))o&&(e[0]+=` ${a}=""`);else if(a==="dangerouslySetInnerHTML"){if(r.length>0)throw new Error("Can only set one of `children` or `props.dangerouslySetInnerHTML`.");r=[X(o.__html)]}else if(o instanceof Promise)e[0]+=` ${a}="`,e.unshift('"',o);else if(typeof o=="function"){if(!a.startsWith("on")&&a!=="ref")throw new Error(`Invalid prop '${a}' of type 'function' supplied to '${t}'.`)}else e[0]+=` ${a}="`,Te(o.toString(),e),e[0]+='"'}if(Aa.includes(t)&&r.length===0){e[0]+="/>";return}e[0]+=">",Ps(r,e),e[0]+=`</${t}>`}},ss=class extends re{toStringToBuffer(e){const{children:t}=this,s={...this.props};t.length&&(s.children=t.length===1?t[0]:t);const r=this.tag.call(null,s);if(!(typeof r=="boolean"||r==null))if(r instanceof Promise)if(tt.length===0)e.unshift("",r);else{const n=tt.map(a=>[a,a.values.at(-1)]);e.unshift("",r.then(a=>(a instanceof re&&(a.localContexts=n),a)))}else r instanceof re?r.toStringToBuffer(e):typeof r=="number"||r.isEscaped?(e[0]+=r,r.callbacks&&(e.callbacks||(e.callbacks=[]),e.callbacks.push(...r.callbacks))):Te(r,e)}},zr=class extends re{toStringToBuffer(e){Ps(this.children,e)}},Ys=(e,t,...s)=>{t??(t={}),s.length&&(t.children=s.length===1?s[0]:s);const r=t.key;delete t.key;const n=$t(e,t,s);return n.key=r,n},Zs=!1,$t=(e,t,s)=>{if(!Zs){for(const r in xs)ts[r][js]=xs[r];Zs=!0}return typeof e=="function"?new ss(e,t,s):ts[e]?new ss(ts[e],t,s):e==="svg"||e==="head"?(ht||(ht=Rs("")),new re(e,t,[new ss(ht,{value:e},s)])):new re(e,t,s)},ot=({children:e})=>new zr("",{children:e},Array.isArray(e)?e:e?[e]:[]);function l(e,t,s){let r;if(!t||!("children"in t))r=$t(e,t,[]);else{const n=t.children;r=Array.isArray(n)?$t(e,t,n):$t(e,t,[n])}return r.key=s,r}var pt="_hp",Ea={Change:"Input",DoubleClick:"DblClick"},Sa={svg:"2000/svg",math:"1998/Math/MathML"},ft=[],ws=new WeakMap,st=void 0,ja=()=>st,ie=e=>"t"in e,rs={onClick:["click",!1]},er=e=>{if(!e.startsWith("on"))return;if(rs[e])return rs[e];const t=e.match(/^on([A-Z][a-zA-Z]+?(?:PointerCapture)?)(Capture)?$/);if(t){const[,s,r]=t;return rs[e]=[(Ea[s]||s).toLowerCase(),!!r]}},tr=(e,t)=>st&&e instanceof SVGElement&&/[A-Z]/.test(t)&&(t in e.style||t.match(/^(?:o|pai|str|u|ve)/))?t.replace(/([A-Z])/g,"-$1").toLowerCase():t,Ra=(e,t,s)=>{var r;t||(t={});for(let n in t){const a=t[n];if(n!=="children"&&(!s||s[n]!==a)){n=Kt(n);const o=er(n);if(o){if((s==null?void 0:s[n])!==a&&(s&&e.removeEventListener(o[0],s[n],o[1]),a!=null)){if(typeof a!="function")throw new Error(`Event handler for "${n}" is not a function`);e.addEventListener(o[0],a,o[1])}}else if(n==="dangerouslySetInnerHTML"&&a)e.innerHTML=a.__html;else if(n==="ref"){let i;typeof a=="function"?i=a(e)||(()=>a(null)):a&&"current"in a&&(a.current=e,i=()=>a.current=null),ws.set(e,i)}else if(n==="style"){const i=e.style;typeof a=="string"?i.cssText=a:(i.cssText="",a!=null&&Kr(a,i.setProperty.bind(i)))}else{if(n==="value"){const c=e.nodeName;if(c==="INPUT"||c==="TEXTAREA"||c==="SELECT"){if(e.value=a==null||a===!1?null:a,c==="TEXTAREA"){e.textContent=a;continue}else if(c==="SELECT"){e.selectedIndex===-1&&(e.selectedIndex=0);continue}}}else(n==="checked"&&e.nodeName==="INPUT"||n==="selected"&&e.nodeName==="OPTION")&&(e[n]=a);const i=tr(e,n);a==null||a===!1?e.removeAttribute(i):a===!0?e.setAttribute(i,""):typeof a=="string"||typeof a=="number"?e.setAttribute(i,a):e.setAttribute(i,a.toString())}}}if(s)for(let n in s){const a=s[n];if(n!=="children"&&!(n in t)){n=Kt(n);const o=er(n);o?e.removeEventListener(o[0],a,o[1]):n==="ref"?(r=ws.get(e))==null||r():e.removeAttribute(tr(e,n))}}},Ca=(e,t)=>{t[H][0]=0,ft.push([e,t]);const s=t.tag[js]||t.tag,r=s.defaultProps?{...s.defaultProps,...t.props}:t.props;try{return[s.call(null,r)]}finally{ft.pop()}},Jr=(e,t,s,r,n)=>{var a,o;(a=e.vR)!=null&&a.length&&(r.push(...e.vR),delete e.vR),typeof e.tag=="function"&&((o=e[H][1][Yr])==null||o.forEach(i=>n.push(i))),e.vC.forEach(i=>{var c;if(ie(i))s.push(i);else if(typeof i.tag=="function"||i.tag===""){i.c=t;const d=s.length;if(Jr(i,t,s,r,n),i.s){for(let u=d;u<s.length;u++)s[u].s=!0;i.s=!1}}else s.push(i),(c=i.vR)!=null&&c.length&&(r.push(...i.vR),delete i.vR)})},Pa=e=>{for(;;e=e.tag===pt||!e.vC||!e.pP?e.nN:e.vC[0]){if(!e)return null;if(e.tag!==pt&&e.e)return e.e}},Qr=e=>{var t,s,r,n,a,o;ie(e)||((s=(t=e[H])==null?void 0:t[1][Yr])==null||s.forEach(i=>{var c;return(c=i[2])==null?void 0:c.call(i)}),(r=ws.get(e.e))==null||r(),e.p===2&&((n=e.vC)==null||n.forEach(i=>i.p=2)),(a=e.vC)==null||a.forEach(Qr)),e.p||((o=e.e)==null||o.remove(),delete e.e),typeof e.tag=="function"&&(ct.delete(e),Ut.delete(e),delete e[H][3],e.a=!0)},Xr=(e,t,s)=>{e.c=t,Vr(e,t,s)},sr=(e,t)=>{if(t){for(let s=0,r=e.length;s<r;s++)if(e[s]===t)return s}},rr=Symbol(),Vr=(e,t,s)=>{var d;const r=[],n=[],a=[];Jr(e,t,r,n,a),n.forEach(Qr);const o=s?void 0:t.childNodes;let i,c=null;if(s)i=-1;else if(!o.length)i=0;else{const u=sr(o,Pa(e.nN));u!==void 0?(c=o[u],i=u):i=sr(o,(d=r.find(p=>p.tag!==pt&&p.e))==null?void 0:d.e)??-1,i===-1&&(s=!0)}for(let u=0,p=r.length;u<p;u++,i++){const f=r[u];let m;if(f.s&&f.e)m=f.e,f.s=!1;else{const w=s||!f.e;ie(f)?(f.e&&f.d&&(f.e.textContent=f.t),f.d=!1,m=f.e||(f.e=document.createTextNode(f.t))):(m=f.e||(f.e=f.n?document.createElementNS(f.n,f.tag):document.createElement(f.tag)),Ra(m,f.props,f.pP),Vr(f,m,w))}f.tag===pt?i--:s?m.parentNode||t.appendChild(m):o[i]!==m&&o[i-1]!==m&&(o[i+1]===m?t.appendChild(o[i]):t.insertBefore(m,c||o[i]||null))}if(e.pP&&delete e.pP,a.length){const u=[],p=[];a.forEach(([,f,,m,w])=>{f&&u.push(f),m&&p.push(m),w==null||w()}),u.forEach(f=>f()),p.length&&requestAnimationFrame(()=>{p.forEach(f=>f())})}},_a=(e,t)=>!!(e&&e.length===t.length&&e.every((s,r)=>s[1]===t[r][1])),Ut=new WeakMap,bs=(e,t,s)=>{var a,o,i,c,d,u;const r=!s&&t.pC;s&&(t.pC||(t.pC=t.vC));let n;try{s||(s=typeof t.tag=="function"?Ca(e,t):Tt(t.props.children)),((a=s[0])==null?void 0:a.tag)===""&&s[0][gs]&&(n=s[0][gs],e[5].push([e,n,t]));const p=r?[...t.pC]:t.vC?[...t.vC]:void 0,f=[];let m;for(let w=0;w<s.length;w++){Array.isArray(s[w])&&s.splice(w,1,...s[w].flat());let v=Ma(s[w]);if(v){typeof v.tag=="function"&&!v.tag[qr]&&(tt.length>0&&(v[H][2]=tt.map(b=>[b,b.values.at(-1)])),(o=e[5])!=null&&o.length&&(v[H][3]=e[5].at(-1)));let g;if(p&&p.length){const b=p.findIndex(ie(v)?O=>ie(O):v.key!==void 0?O=>O.key===v.key&&O.tag===v.tag:O=>O.tag===v.tag);b!==-1&&(g=p[b],p.splice(b,1))}if(g)if(ie(v))g.t!==v.t&&(g.t=v.t,g.d=!0),v=g;else{const b=g.pP=g.props;if(g.props=v.props,g.f||(g.f=v.f||t.f),typeof v.tag=="function"){const O=g[H][2];g[H][2]=v[H][2]||[],g[H][3]=v[H][3],!g.f&&((g.o||g)===v.o||(c=(i=g.tag)[pa])!=null&&c.call(i,b,g.props))&&_a(O,g[H][2])&&(g.s=!0)}v=g}else if(!ie(v)&&st){const b=at(st);b&&(v.n=b)}if(!ie(v)&&!v.s&&(bs(e,v),delete v.f),f.push(v),m&&!m.s&&!v.s)for(let b=m;b&&!ie(b);b=(d=b.vC)==null?void 0:d.at(-1))b.nN=v;m=v}}t.vR=r?[...t.vC,...p||[]]:p||[],t.vC=f,r&&delete t.pC}catch(p){if(t.f=!0,p===rr){if(n)return;throw p}const[f,m,w]=((u=t[H])==null?void 0:u[3])||[];if(m){const v=()=>qt([0,!1,e[2]],w),g=Ut.get(w)||[];g.push(v),Ut.set(w,g);const b=m(p,()=>{const O=Ut.get(w);if(O){const S=O.indexOf(v);if(S!==-1)return O.splice(S,1),v()}});if(b){if(e[0]===1)e[1]=!0;else if(bs(e,w,[b]),(m.length===1||e!==f)&&w.c){Xr(w,w.c,!1);return}throw rr}}throw p}finally{n&&e[5].pop()}},Ma=e=>{if(!(e==null||typeof e=="boolean")){if(typeof e=="string"||typeof e=="number")return{t:e.toString(),d:!0};if("vR"in e&&(e={tag:e.tag,props:e.props,key:e.key,f:e.f,type:e.tag,ref:e.props.ref,o:e.o||e}),typeof e.tag=="function")e[H]=[0,[]];else{const t=Sa[e.tag];t&&(st||(st=Wr("")),e.props.children=[{tag:st,props:{value:e.n=`http://www.w3.org/${t}`,children:e.props.children}}])}return e}},nr=(e,t)=>{var s,r;(s=t[H][2])==null||s.forEach(([n,a])=>{n.values.push(a)});try{bs(e,t,void 0)}catch{return}if(t.a){delete t.a;return}(r=t[H][2])==null||r.forEach(([n])=>{n.values.pop()}),(e[0]!==1||!e[1])&&Xr(t,t.c,!1)},ct=new WeakMap,ar=[],qt=async(e,t)=>{e[5]||(e[5]=[]);const s=ct.get(t);s&&s[0](void 0);let r;const n=new Promise(a=>r=a);if(ct.set(t,[r,()=>{e[2]?e[2](e,t,a=>{nr(a,t)}).then(()=>r(t)):(nr(e,t),r(t))}]),ar.length)ar.at(-1).add(t);else{await Promise.resolve();const a=ct.get(t);a&&(ct.delete(t),a[1]())}return n},Ia=(e,t,s)=>({tag:pt,props:{children:e},key:s,e:t,p:1}),ns=0,Yr=1,as=2,os=3,is=new WeakMap,Zr=(e,t)=>!e||!t||e.length!==t.length||t.some((s,r)=>s!==e[r]),Da=void 0,or=[],Na=e=>{var o;const t=()=>typeof e=="function"?e():e,s=ft.at(-1);if(!s)return[t(),()=>{}];const[,r]=s,n=(o=r[H][1])[ns]||(o[ns]=[]),a=r[H][0]++;return n[a]||(n[a]=[t(),i=>{const c=Da,d=n[a];if(typeof i=="function"&&(i=i(d[0])),!Object.is(i,d[0]))if(d[0]=i,or.length){const[u,p]=or.at(-1);Promise.all([u===3?r:qt([u,!1,c],r),p]).then(([f])=>{if(!f||!(u===2||u===3))return;const m=f.vC;requestAnimationFrame(()=>{setTimeout(()=>{m===f.vC&&qt([u===3?1:0,!1,c],f)})})})}else qt([0,!1,c],r)}])},_s=(e,t)=>{var i;const s=ft.at(-1);if(!s)return e;const[,r]=s,n=(i=r[H][1])[as]||(i[as]=[]),a=r[H][0]++,o=n[a];return Zr(o==null?void 0:o[1],t)?n[a]=[e,t]:e=n[a][0],e},Ha=e=>{const t=is.get(e);if(t){if(t.length===2)throw t[1];return t[0]}throw e.then(s=>is.set(e,[s]),s=>is.set(e,[void 0,s])),e},La=(e,t)=>{var i;const s=ft.at(-1);if(!s)return e();const[,r]=s,n=(i=r[H][1])[os]||(i[os]=[]),a=r[H][0]++,o=n[a];return Zr(o==null?void 0:o[1],t)&&(n[a]=[e(),t]),n[a][0]},$a=Wr({pending:!1,data:null,method:null,action:null}),ir=new Set,Ua=e=>{ir.add(e),e.finally(()=>ir.delete(e))},Ms=(e,t)=>La(()=>s=>{let r;e&&(typeof e=="function"?r=e(s)||(()=>{e(null)}):e&&"current"in e&&(e.current=s,r=()=>{e.current=null}));const n=t(s);return()=>{n==null||n(),r==null||r()}},[e]),qe=Object.create(null),Ct=Object.create(null),Et=(e,t,s,r,n)=>{if(t!=null&&t.itemProp)return{tag:e,props:t,type:e,ref:t.ref};const a=document.head;let{onLoad:o,onError:i,precedence:c,blocking:d,...u}=t,p=null,f=!1;const m=Ht[e];let w;if(m.length>0){const O=a.querySelectorAll(e);e:for(const S of O)for(const k of Ht[e])if(S.getAttribute(k)===t[k]){p=S;break e}if(!p){const S=m.reduce((k,P)=>t[P]===void 0?k:`${k}-${P}-${t[P]}`,e);f=!Ct[S],p=Ct[S]||(Ct[S]=(()=>{const k=document.createElement(e);for(const P of m)t[P]!==void 0&&k.setAttribute(P,t[P]),t.rel&&k.setAttribute("rel",t.rel);return k})())}}else w=a.querySelectorAll(e);c=r?c??"":void 0,r&&(u[Lt]=c);const v=_s(O=>{if(m.length>0){let S=!1;for(const k of a.querySelectorAll(e)){if(S&&k.getAttribute(Lt)!==c){a.insertBefore(O,k);return}k.getAttribute(Lt)===c&&(S=!0)}a.appendChild(O)}else if(w){let S=!1;for(const k of w)if(k===O){S=!0;break}S||a.insertBefore(O,a.contains(w[0])?w[0]:a.querySelector(e)),w=void 0}},[c]),g=Ms(t.ref,O=>{var P;const S=m[0];if(s===2&&(O.innerHTML=""),(f||w)&&v(O),!i&&!o)return;let k=qe[P=O.getAttribute(S)]||(qe[P]=new Promise((z,C)=>{O.addEventListener("load",z),O.addEventListener("error",C)}));o&&(k=k.then(o)),i&&(k=k.catch(i)),k.catch(()=>{})});if(n&&d==="render"){const O=Ht[e][0];if(t[O]){const S=t[O],k=qe[S]||(qe[S]=new Promise((P,z)=>{v(p),p.addEventListener("load",P),p.addEventListener("error",z)}));Ha(k)}}const b={tag:e,type:e,props:{...u,ref:g},ref:g};return b.p=s,p&&(b.e=p),Ia(b,a)},qa=e=>{const t=ja(),s=t&&at(t);return s!=null&&s.endsWith("svg")?{tag:"title",props:e,type:"title",ref:e.ref}:Et("title",e,void 0,!1,!1)},Fa=e=>!e||["src","async"].some(t=>!e[t])?{tag:"script",props:e,type:"script",ref:e.ref}:Et("script",e,1,!1,!0),Wa=e=>!e||!["href","precedence"].every(t=>t in e)?{tag:"style",props:e,type:"style",ref:e.ref}:(e["data-href"]=e.href,delete e.href,Et("style",e,2,!0,!0)),Ba=e=>!e||["onLoad","onError"].some(t=>t in e)||e.rel==="stylesheet"&&(!("precedence"in e)||"disabled"in e)?{tag:"link",props:e,type:"link",ref:e.ref}:Et("link",e,1,"precedence"in e,!0),Ga=e=>Et("meta",e,void 0,!1,!1),en=Symbol(),Ka=e=>{const{action:t,...s}=e;typeof t!="function"&&(s.action=t);const[r,n]=Na([null,!1]),a=_s(async d=>{const u=d.isTrusted?t:d.detail[en];if(typeof u!="function")return;d.preventDefault();const p=new FormData(d.target);n([p,!0]);const f=u(p);f instanceof Promise&&(Ua(f),await f),n([null,!0])},[]),o=Ms(e.ref,d=>(d.addEventListener("submit",a),()=>{d.removeEventListener("submit",a)})),[i,c]=r;return r[1]=!1,{tag:$a,props:{value:{pending:i!==null,data:i,method:i?"post":null,action:i?t:null},children:{tag:"form",props:{...s,ref:o},type:"form",ref:o}},f:c}},tn=(e,{formAction:t,...s})=>{if(typeof t=="function"){const r=_s(n=>{n.preventDefault(),n.currentTarget.form.dispatchEvent(new CustomEvent("submit",{detail:{[en]:t}}))},[]);s.ref=Ms(s.ref,n=>(n.addEventListener("click",r),()=>{n.removeEventListener("click",r)}))}return{tag:e,props:s,type:e,ref:s.ref}},za=e=>tn("input",e),Ja=e=>tn("button",e);Object.assign(xs,{title:qa,script:Fa,style:Wa,link:Ba,meta:Ga,form:Ka,input:za,button:Ja});Rs(null);new TextEncoder;var Qa=Rs(null),Xa=(e,t,s,r)=>(n,a)=>{const o="<!DOCTYPE html>",i=s?Ys(d=>s(d,e),{Layout:t,...a},n):n,c=Ss`${X(o)}${Ys(Qa.Provider,{value:e},i)}`;return e.html(c)},Va=(e,t)=>function(r,n){const a=r.getLayout()??ot;return e&&r.setLayout(o=>e({...o,Layout:a},r)),r.setRenderer(Xa(r,a,e)),n()};const Ya=Va(({children:e,title:t})=>l("html",{lang:"zh-CN",children:[l("head",{children:[l("meta",{charSet:"UTF-8"}),l("meta",{name:"viewport",content:"width=device-width, initial-scale=1.0"}),l("title",{children:t||"OpenClaw Helper"}),l("link",{rel:"stylesheet",href:"/tailwind.css"}),l("style",{dangerouslySetInnerHTML:{__html:"[x-cloak]{display:none!important}.hx-loading{display:none!important}.htmx-request.hx-loading,.htmx-request .hx-loading{display:inline-flex!important}.htmx-request>.hx-ready{display:none!important}"}}),l("script",{src:"https://unpkg.com/htmx.org@2.0.4"}),l("script",{defer:!0,src:"https://cdn.jsdelivr.net/npm/alpinejs@3.14.8/dist/cdn.min.js"})]}),l("body",{class:"min-h-screen bg-gradient-to-br from-slate-950 via-indigo-950 to-purple-900 text-slate-100 font-sans",children:e})]})),Za=Object.freeze(Object.defineProperty({__proto__:null,default:Ya},Symbol.toStringTag,{value:"Module"}));var De,Or,eo=(Or=class{constructor(e){x(this,"initApp");A(this,De);x(this,"createApp",e=>{const t=new Ae(e&&h(this,De)?{...h(this,De),...e}:e??h(this,De));return this.initApp&&this.initApp(t),t});x(this,"createMiddleware",e=>e);x(this,"createHandlers",(...e)=>e.filter(t=>t!==void 0));this.initApp=e==null?void 0:e.initApp,y(this,De,e==null?void 0:e.defaultAppOptions)}},De=new WeakMap,Or),to=e=>new eo(e),ls=e=>e;const so=to(),sn=so.createHandlers,ro=`
document.addEventListener('alpine:init', () => {
  Alpine.data('modelAdder', () => ({
    provider: '',
    minimaxToken: '',
    loading: false,
    alert: null,
    _alertTimer: null,
    oauth: { show: false, title: '', output: '', showOpen: false, showDone: false, openUrl: '', ws: null },

    get canSubmit() {
      if (this.provider === 'minimax') return !!this.minimaxToken;
      return !!this.provider;
    },

    showAlert(type, message) {
      if (this._alertTimer) clearTimeout(this._alertTimer);
      this.alert = { type, message };
      this._alertTimer = setTimeout(() => { this.alert = null; }, 5000);
      // 同时触发全局提示
      window.dispatchEvent(new CustomEvent('show-alert', { detail: { type, message } }));
    },

    closeOAuth() {
      this.oauth.show = false;
      if (this.oauth.ws) { this.oauth.ws.close(); this.oauth.ws = null; }
    },

    onModelSuccess() {
      this.showAlert('success', '模型配置成功！');
      this.provider = '';
      this.minimaxToken = '';
      // 刷新模型列表
      htmx.ajax('GET', '/api/partials/models', { target: '#model-list', swap: 'innerHTML' });
    },

    async submitModel() {
      if (!this.canSubmit) return;
      this.loading = true;
      try {
        const res = await fetch('/api/config/model', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ provider: this.provider, token: this.minimaxToken || undefined })
        });
        const result = await res.json();
        this.loading = false;
        if (result.success && result.data.requiresOAuth) {
          if (result.data.oauthMode === 'auto') this.startGptOAuth();
          else if (result.data.oauthMode === 'device') this.startQwenDevice();
          else if (result.data.manualOAuth) this.showManualOAuth(result.data.command);
          else this.startWsOAuth(this.provider);
        } else if (result.success) {
          this.onModelSuccess();
        } else {
          this.showAlert('error', result.error || '配置失败');
        }
      } catch (err) {
        this.loading = false;
        this.showAlert('error', '网络错误: ' + err.message);
      }
    },

    async startGptOAuth() {
      this.oauth = { show: true, title: 'GPT OAuth 登录', output: '正在启动 ChatGPT OAuth 授权...', showOpen: true, showDone: false, openUrl: '', ws: null };
      try {
        const res = await fetch('/api/config/gpt-oauth/start', { method: 'POST', headers: { 'Content-Type': 'application/json' } });
        const result = await res.json();
        if (!result.success) { this.oauth.output = '<div class="text-red-400">✗ ' + (result.error || '启动失败') + '</div>'; return; }
        const { sessionId, authUrl } = result.data;
        this.oauth.openUrl = authUrl;
        this.oauth.output = '<div style="color:#fbbf24;font-weight:bold;margin-bottom:12px">⏳ 等待授权中...</div>\\n请在浏览器中打开以下链接完成授权：\\n\\n' + authUrl + '\\n\\n<div style="color:#10b981;font-weight:bold;margin-top:12px">✓ 授权完成后将自动刷新模型列表</div>';
        window.open(authUrl, '_blank');
        this.pollOAuth('/api/config/gpt-oauth/poll', sessionId, 2000);
      } catch (err) { this.oauth.output = '<div class="text-red-400">✗ 网络错误: ' + err.message + '</div>'; }
    },

    async startQwenDevice() {
      this.oauth = { show: true, title: '千问 OAuth 登录', output: '正在请求授权链接...', showOpen: true, showDone: false, openUrl: '', ws: null };
      try {
        const res = await fetch('/api/config/qwen-oauth/start', { method: 'POST', headers: { 'Content-Type': 'application/json' } });
        const result = await res.json();
        if (!result.success) { this.oauth.output = '<div class="text-red-400">✗ ' + (result.error || '启动失败') + '</div>'; return; }
        const { sessionId, verificationUrl, userCode, interval } = result.data;
        this.oauth.openUrl = verificationUrl;
        this.oauth.output = '<div style="color:#fbbf24;font-weight:bold;margin-bottom:12px">⏳ 等待授权中...</div>\\n\\n请在浏览器打开以下链接完成授权：\\n\\n' + verificationUrl + '\\n\\n<div style="color:#8b5cf6;font-weight:bold;margin:12px 0">验证码：' + userCode + '</div>\\n\\n<div style="color:#10b981;font-weight:bold;margin-top:12px">✓ 授权完成后将自动刷新模型列表</div>';
        window.open(verificationUrl, '_blank');
        this.pollOAuth('/api/config/qwen-oauth/poll', sessionId, Math.max(2000, (interval || 2) * 1000));
      } catch (err) { this.oauth.output = '<div class="text-red-400">✗ 网络错误: ' + err.message + '</div>'; }
    },

    async pollOAuth(url, sessionId, ms) {
      try {
        const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ sessionId }) });
        const r = await res.json();
        if (r.success && r.data?.status === 'pending') { setTimeout(() => this.pollOAuth(url, sessionId, ms), ms); return; }
        if (r.success && r.data?.status === 'success') {
          this.oauth.output += '\\n<div class="text-emerald-400">✓ 登录成功</div>';
          setTimeout(() => { this.closeOAuth(); this.onModelSuccess(); }, 1000);
          return;
        }
        this.oauth.output += '\\n<div class="text-red-400">✗ ' + (r.error || '登录失败') + '</div>';
      } catch { this.oauth.output += '\\n<div class="text-red-400">✗ 轮询失败</div>'; }
    },

    showManualOAuth(command) {
      this.oauth = { show: true, title: 'OAuth 登录', output: '当前环境无法创建交互式终端。\\n请在你的本地终端执行以下命令完成登录：\\n\\n' + (command || '') + '\\n\\n完成后点击"已完成登录"。', showOpen: false, showDone: true, openUrl: '', ws: null };
    },
    manualOAuthDone() {
      this.closeOAuth();
      this.onModelSuccess();
    },

    startWsOAuth(provider) {
      const label = provider === 'gpt' ? 'GPT' : '千问';
      this.oauth = { show: true, title: label + ' OAuth 登录', output: '正在启动 ' + label + ' OAuth 登录...\\n\\n', showOpen: false, showDone: false, openUrl: '', ws: null };
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      const ws = new WebSocket(protocol + '//' + window.location.host + '/ws/oauth-login');
      this.oauth.ws = ws;
      ws.onopen = () => ws.send(JSON.stringify({ provider }));
      ws.onmessage = (e) => {
        const d = JSON.parse(e.data);
        if (d.type === 'output') this.oauth.output += d.data;
        else if (d.type === 'success') {
          this.oauth.output += '\\n<div class="text-emerald-400">✓ ' + d.message + '</div>';
          setTimeout(() => { this.closeOAuth(); this.onModelSuccess(); }, 2000);
        } else if (d.type === 'error') {
          this.oauth.output += '\\n<div class="text-red-400">✗ ' + d.message + '</div>';
          setTimeout(() => { this.closeOAuth(); this.showAlert('error', '登录失败: ' + d.message); }, 2000);
        }
      };
      ws.onerror = () => {
        this.oauth.output += '\\n<div class="text-red-400">✗ 连接错误</div>';
        setTimeout(() => { this.closeOAuth(); this.showAlert('error', 'WebSocket 连接失败'); }, 2000);
      };
    }
  }))
})
`,no=`
document.addEventListener('alpine:init', () => {
  Alpine.data('whatsappLinker', () => ({
    // 状态: idle | loading | qr | success | error
    state: 'idle',
    loadingStep: '',
    qrDataUrl: '',
    errorMsg: '',
    pollCount: 0,
    maxPolls: 60,
    _pollTimer: null,

    destroy() {
      if (this._pollTimer) {
        clearTimeout(this._pollTimer);
        this._pollTimer = null;
      }
    },

    async startLinking() {
      this.state = 'loading';
      this.loadingStep = '正在注销旧会话并生成新的二维码...';
      this.errorMsg = '';
      this.qrDataUrl = '';
      this.pollCount = 0;

      try {
        this.loadingStep = '① 注销旧 WhatsApp 会话...';
        const res = await fetch('/api/config/whatsapp/link/start', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
        });
        this.loadingStep = '② 生成二维码中...';
        const result = await res.json();

        if (!result.success) {
          this.state = 'error';
          this.errorMsg = result.error || 'WhatsApp 链接启动失败';
          return;
        }

        if (!result.data.qrDataUrl) {
          this.state = 'error';
          this.errorMsg = '未能获取二维码，请确认 Gateway 已启动且 WhatsApp 插件已安装';
          return;
        }

        this.qrDataUrl = result.data.qrDataUrl;
        this.state = 'qr';
        // 开始轮询扫码状态
        this.pollLinkStatus();
      } catch (err) {
        this.state = 'error';
        this.errorMsg = '网络错误: ' + (err.message || '请检查网络连接');
      }
    },

    async pollLinkStatus() {
      if (this.state !== 'qr') return;
      if (this.pollCount >= this.maxPolls) {
        this.state = 'error';
        this.errorMsg = '等待超时，请重新生成二维码';
        return;
      }

      this.pollCount++;
      try {
        const res = await fetch('/api/config/whatsapp/link/poll', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
        });
        const result = await res.json();

        if (result.success && result.data.connected) {
          this.state = 'success';
          // 触发全局提示
          window.dispatchEvent(new CustomEvent('show-alert', {
            detail: { type: 'success', message: 'WhatsApp 连接成功！' }
          }));
          // 刷新渠道列表
          if (typeof htmx !== 'undefined') {
            htmx.ajax('GET', '/api/partials/channels', { target: '#channel-list', swap: 'innerHTML' });
            htmx.ajax('GET', '/api/partials/channels/available', { target: '#available-channels', swap: 'innerHTML' });
          }
          return;
        }

        // 继续轮询
        this._pollTimer = setTimeout(() => this.pollLinkStatus(), 3000);
      } catch {
        // 网络错误时继续尝试
        this._pollTimer = setTimeout(() => this.pollLinkStatus(), 5000);
      }
    },

    reset() {
      if (this._pollTimer) {
        clearTimeout(this._pollTimer);
        this._pollTimer = null;
      }
      this.state = 'idle';
      this.qrDataUrl = '';
      this.errorMsg = '';
      this.pollCount = 0;
    },

    close() {
      this.reset();
      const area = document.getElementById('channel-form-area');
      if (area) area.innerHTML = '';
    }
  }))
})
`;var lr=Object.freeze,ao=Object.defineProperty,oo=(e,t)=>lr(ao(e,"raw",{value:lr(e.slice())})),cr;const io=sn(e=>e.render(Ss(cr||(cr=oo([`
    <div x-data="{ tab: 'models', alert: null, _t: null }"
         @show-alert.window="alert = $event.detail; clearTimeout(_t); _t = setTimeout(() => alert = null, 5000)">

      <div class="h-screen w-full px-6 py-10 overflow-y-auto">
        <div class="mx-auto grid w-full max-w-7xl grid-cols-1 gap-6 lg:grid-cols-[260px_1fr]">

          <!-- 侧边栏 -->
          <aside class="rounded-2xl bg-slate-900/80 p-6 text-slate-200 shadow-xl">
            <div class="text-sm font-semibold text-white">OpenClaw 控制台</div>
            <div class="mt-1 text-xs text-slate-400">更多配置指引</div>
            <div class="mt-6 flex flex-col gap-2">
              <button @click="tab='models'" :class="tab==='models' ? 'bg-slate-800 text-white' : 'text-slate-300'" class="rounded-lg px-3 py-2 text-left text-sm">模型</button>
              <button @click="tab='channels'" :class="tab==='channels' ? 'bg-slate-800 text-white' : 'text-slate-300'" class="rounded-lg px-3 py-2 text-left text-sm">渠道</button>
              <button @click="tab='skills'" :class="tab==='skills' ? 'bg-slate-800 text-white' : 'text-slate-300'" class="rounded-lg px-3 py-2 text-left text-sm">技能</button>
              <button @click="tab='remote'" :class="tab==='remote' ? 'bg-slate-800 text-white' : 'text-slate-300'" class="rounded-lg px-3 py-2 text-left text-sm">远程支持</button>
            </div>
          </aside>

          <!-- 主内容 -->
          <main class="rounded-2xl bg-white p-8 text-slate-700 shadow-2xl">
            <div class="flex flex-wrap items-center justify-between gap-4">
              <div>
                <h1 class="text-2xl font-semibold text-slate-800">配置中心</h1>
                <p class="mt-1 text-sm text-slate-500">集中管理模型、渠道、技能与远程支持</p>
              </div>
              <a class="rounded-lg border border-slate-200 px-4 py-2 text-sm text-slate-600 hover:bg-slate-100" href="/">返回配置助手</a>
            </div>

            <!-- 全局提示 -->
            <div x-show="alert && alert.type === 'error'" x-cloak x-text="alert?.message" class="mt-6 rounded-xl border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700"></div>
            <div x-show="alert && alert.type === 'success'" x-cloak x-text="alert?.message" class="mt-6 rounded-xl border border-emerald-200 bg-emerald-50 px-4 py-3 text-sm text-emerald-700"></div>

            <!-- ═══ 模型管理 ═══ -->
            <div x-show="tab==='models'">
              <div class="rounded-2xl border border-slate-200 bg-slate-50 p-6">
                <h4 class="text-lg font-semibold text-slate-800">已配置模型</h4>
                <p class="mt-2 text-sm text-slate-500">下方显示当前 OpenClaw 配置的模型及其支持的输入类型，点击可快速切换默认模型。</p>
                <div class="mt-4 grid gap-3 md:grid-cols-2 xl:grid-cols-3"
                     id="model-list"
                     hx-get="/api/partials/models"
                     hx-trigger="load"
                     hx-swap="innerHTML">
                  <p class="text-sm text-slate-400">加载中...</p>
                </div>
              </div>

              <!-- 新增模型 -->
              <div class="mt-6 rounded-2xl border border-slate-200 bg-white p-6" x-data="modelAdder">

                <!-- OAuth 弹窗 -->
                <div x-show="oauth.show" x-cloak class="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70">
                  <div class="w-full max-w-2xl rounded-2xl bg-slate-900 text-slate-100 shadow-2xl">
                    <div class="flex items-center justify-between border-b border-slate-700 px-5 py-3">
                      <div class="text-sm" x-text="oauth.title"></div>
                      <button class="text-xl text-slate-400 hover:text-white" @click="closeOAuth()">×</button>
                    </div>
                    <div class="max-h-[520px] overflow-y-auto px-5 py-4 font-mono text-sm">
                      <div class="whitespace-pre-wrap" x-html="oauth.output"></div>
                      <div class="mt-4 flex justify-end gap-2">
                        <button x-show="oauth.showOpen" @click="window.open(oauth.openUrl,'_blank')" class="rounded-lg border border-slate-600 px-4 py-2 text-sm text-slate-200 hover:bg-slate-800">打开授权页面</button>
                        <button x-show="oauth.showDone" @click="manualOAuthDone()" class="rounded-lg bg-indigo-500 px-4 py-2 text-sm text-white hover:bg-indigo-400">已完成登录</button>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Loading -->
                <div x-show="loading" x-cloak class="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/40">
                  <div class="rounded-2xl bg-white px-6 py-5 text-center shadow-xl">
                    <div class="mx-auto mb-3 h-10 w-10 animate-spin rounded-full border-4 border-slate-200 border-t-indigo-500"></div>
                    <p class="text-sm text-slate-600">正在配置中，请稍候...</p>
                  </div>
                </div>

                <h4 class="text-lg font-semibold text-slate-800">新增模型</h4>
                <p class="mt-2 text-sm text-slate-500">选择提供商，通过 OAuth 登录或填写 API Key 添加模型。</p>

                <div class="mt-4">
                  <label class="mb-2 block text-sm font-medium text-slate-600">选择模型提供商</label>
                  <select x-model="provider" class="w-full rounded-xl border border-slate-200 bg-white px-4 py-3 text-sm text-slate-700 focus:border-indigo-400 focus:outline-none">
                    <option value="">-- 请选择 --</option>
                    <option value="minimax">MiniMax (需要 API Key)</option>
                    <option value="gpt">GPT (通过 ChatGPT OAuth 登录)</option>
                    <option value="qwen">千问 (通过 OAuth 登录)</option>
                  </select>
                </div>

                <div x-show="provider === 'minimax'" x-cloak class="mt-4">
                  <label class="mb-2 block text-sm font-medium text-slate-600">MiniMax API Key</label>
                  <input type="text" x-model="minimaxToken" placeholder="请输入 MiniMax API Key" class="w-full rounded-xl border border-slate-200 bg-white px-4 py-3 text-sm text-slate-700 focus:border-indigo-400 focus:outline-none" />
                </div>

                <div class="mt-6 flex justify-end">
                  <button @click="submitModel()" :disabled="!canSubmit" class="rounded-lg bg-indigo-500 px-5 py-2 text-sm text-white hover:bg-indigo-400 disabled:bg-slate-200 disabled:text-slate-400">添加模型</button>
                </div>
              </div>
            </div>

            <!-- ═══ 渠道管理 ═══ -->
            <div x-show="tab==='channels'" x-cloak>
              <div class="rounded-2xl border border-slate-200 bg-slate-50 p-6">
                <h4 class="text-lg font-semibold text-slate-800">已配置渠道</h4>
                <p class="mt-2 text-sm text-slate-500">管理已配置的消息渠道，支持编辑和启用/关闭。</p>
                <div class="mt-4 grid gap-3 md:grid-cols-2"
                     id="channel-list"
                     hx-get="/api/partials/channels"
                     hx-trigger="intersect once"
                     hx-swap="innerHTML">
                  <p class="text-sm text-slate-400">加载中...</p>
                </div>
              </div>
              <div class="mt-6 rounded-2xl border border-slate-200 bg-white p-6">
                <h4 class="text-lg font-semibold text-slate-800">新增渠道</h4>
                <p class="mt-2 text-sm text-slate-500">选择要添加的渠道类型，点击对应按钮开始配置。</p>
                <div id="available-channels"
                     hx-get="/api/partials/channels/available"
                     hx-trigger="intersect once"
                     hx-swap="innerHTML">
                  <p class="mt-4 text-sm text-slate-400">加载中...</p>
                </div>
              </div>
              <div id="channel-form-area" class="mt-6"></div>
            </div>

            <!-- ═══ 技能管理 ═══ -->
            <div x-show="tab==='skills'" x-cloak>
              <div class="rounded-2xl border border-slate-200 bg-slate-50 p-6">
                <h4 class="text-lg font-semibold text-slate-800">预装技能说明</h4>
                <p class="mt-2 text-sm text-slate-500">install.sh 默认安装以下技能，便于快速使用常见能力。</p>
                <div class="mt-4 grid gap-3 md:grid-cols-2 xl:grid-cols-3">
                  <div class="rounded-xl border border-slate-200 bg-white p-4"><strong>blogwatcher</strong><div class="mt-2 text-xs text-slate-500">监控博客更新并推送摘要</div></div>
                  <div class="rounded-xl border border-slate-200 bg-white p-4"><strong>nano-pdf</strong><div class="mt-2 text-xs text-slate-500">快速读取与处理 PDF 内容</div></div>
                  <div class="rounded-xl border border-slate-200 bg-white p-4"><strong>obsidian</strong><div class="mt-2 text-xs text-slate-500">Obsidian 笔记协作工具</div></div>
                  <div class="rounded-xl border border-slate-200 bg-white p-4"><strong>gifgrep</strong><div class="mt-2 text-xs text-slate-500">快速检索 GIF 与短视频帧</div></div>
                  <div class="rounded-xl border border-slate-200 bg-white p-4"><strong>model-usage</strong><div class="mt-2 text-xs text-slate-500">统计模型调用与用量</div></div>
                  <div class="rounded-xl border border-slate-200 bg-white p-4"><strong>video-frames</strong><div class="mt-2 text-xs text-slate-500">提取视频关键帧</div></div>
                  <div class="rounded-xl border border-slate-200 bg-white p-4"><strong>peekaboo</strong><div class="mt-2 text-xs text-slate-500">快速预览内容与格式检查</div></div>
                </div>
              </div>
            </div>

            <!-- ═══ 远程支持 ═══ -->
            <div x-show="tab==='remote'" x-cloak>
              <div class="rounded-2xl border border-slate-200 bg-slate-50 p-6">
                <h4 class="text-lg font-semibold text-slate-800">开启共享登录</h4>
                <p class="mt-2 text-sm text-slate-500">打开设置 → 通用 → 共享 → 打开"共享登录"。</p>
                <div class="mt-4 grid grid-cols-1 gap-4 md:grid-cols-[1.2fr_0.8fr]">
                  <img src="/assets/remote-login-1.png" alt="共享登录步骤 1" class="w-full rounded-2xl border border-slate-200" />
                  <img src="/assets/remote-login-2.png" alt="共享登录步骤 2" class="w-full rounded-2xl border border-slate-200" />
                </div>
              </div>
              <div class="mt-6 rounded-2xl border border-slate-200 bg-white p-6">
                <h4 class="text-lg font-semibold text-slate-800">远程支持配置</h4>
                <div hx-get="/api/partials/remote-support/form"
                     hx-trigger="intersect once"
                     hx-swap="innerHTML">
                  <p class="mt-4 text-sm text-slate-400">加载中...</p>
                </div>
              </div>
            </div>

          </main>
        </div>
      </div>
    </div>
    <script>`,`<\/script>
    <script>`,`<\/script>
    `])),X(ro),X(no)),{title:"OpenClaw 配置指引"})),lo=Object.freeze(Object.defineProperty({__proto__:null,default:io},Symbol.toStringTag,{value:"Module"}));function Is(e){return l("div",{class:"rounded-2xl border border-slate-200 bg-slate-50 p-6",children:[l("h3",{class:"text-lg font-semibold text-slate-700",children:"配置指南"}),l("div",{class:"mt-4 space-y-6 text-sm text-slate-600",children:[l("div",{children:[l("h4",{class:"font-semibold text-slate-700",children:"1. 找到 BotFather"}),l("p",{class:"mt-2",children:["在 Telegram 中搜索 ",l("strong",{children:"@BotFather"}),",确认其名称旁边有蓝色认证标记。"]}),l("img",{src:"/assets/image-1.png",alt:"搜索 BotFather",class:"mt-3 w-full max-w-lg rounded-xl"}),l("p",{class:"mt-3",children:["点击 ",l("strong",{children:"Start"}),"(或输入 ",l("code",{class:"rounded bg-slate-200 px-2 py-1 text-xs",children:"/start"}),")。"]}),l("img",{src:"/assets/image-2.png",alt:"启动 BotFather",class:"mt-3 w-full max-w-lg rounded-xl"})]}),l("div",{children:[l("h4",{class:"font-semibold text-slate-700",children:"2. 创建新机器人"}),l("p",{class:"mt-2",children:["在对话框中输入指令: ",l("code",{class:"rounded bg-slate-200 px-2 py-1 text-xs",children:"/newbot"})]}),l("img",{src:"/assets/image-3.png",alt:"创建机器人",class:"mt-3 w-full max-w-lg rounded-xl"}),l("p",{class:"mt-3",children:[l("strong",{children:"设定名称 (Name)"}),": 这是你的机器人显示的昵称(例如: My Assistant),可以随时更改。"]}),l("img",{src:"/assets/image-4.png",alt:"设置名称",class:"mt-3 w-full max-w-lg rounded-xl"}),l("p",{class:"mt-3",children:[l("strong",{children:"设定用户名 (Username)"}),": 这是用户搜索你的机器人时使用的唯一 ID。必须以 ",l("code",{class:"rounded bg-slate-200 px-2 py-1 text-xs",children:"bot"})," 结尾(例如: my_assistant_2026_bot),且不能与他人重复。"]}),l("img",{src:"/assets/image-5.png",alt:"设置用户名",class:"mt-3 w-full max-w-lg rounded-xl"})]}),l("div",{children:[l("h4",{class:"font-semibold text-slate-700",children:"3. 复制 Token"}),l("p",{class:"mt-2",children:["完成上述步骤后,BotFather 会发送一条包含 ",l("strong",{children:"HTTP API Token"})," 的消息。"]}),l("p",{class:"mt-2",children:["Token 的格式通常类似于: ",l("code",{class:"rounded bg-slate-200 px-2 py-1 text-xs",children:"123456789:ABCDefghIJKLmnopQRSTuvwxYZ"})]}),l("p",{class:"mt-2",children:"直接点击该 Token 即可复制。"}),l("img",{src:"/assets/image-6.png",alt:"复制 Token",class:"mt-3 w-full max-w-lg rounded-xl"}),e.withTokenInput?l(ot,{children:[l("div",{class:"mt-4 rounded-xl border border-amber-300 bg-amber-50 px-4 py-2 text-amber-700 font-semibold",children:"在这里输入 Token"}),l("div",{class:"mt-3",children:[l("label",{for:"tg-token",class:"mb-2 block text-sm font-medium text-slate-600",children:"Telegram Bot Token"}),e.alpineTokenModel?l("input",{type:"text","x-model":e.alpineTokenModel,name:e.inputName,placeholder:e.tokenPlaceholder||"请输入 Bot Token",class:"w-full rounded-xl border border-slate-200 bg-white px-4 py-3 text-sm text-slate-700 focus:border-indigo-400 focus:outline-none"}):l("input",{type:"text",id:"tg-token",name:e.inputName,placeholder:e.tokenPlaceholder||"请输入 Bot Token",class:"w-full rounded-xl border border-slate-200 bg-white px-4 py-3 text-sm text-slate-700 focus:border-indigo-400 focus:outline-none"})]})]}):null]}),l("div",{children:[l("h4",{class:"font-semibold text-slate-700",children:"4. 绑定 TG 用户 ID"}),l("p",{class:"mt-2",children:["在 Telegram 搜索机器人 ",l("strong",{children:"@username_to_id_bot"}),",发送消息获取你的用户 ID。"]}),l("img",{src:"/assets/image-7.png",alt:"获取用户 ID",class:"mt-3 w-full max-w-lg rounded-xl"})]})]})]})}const co=`
document.addEventListener('alpine:init', () => {
  Alpine.data('wizard', () => ({
    step: 1,
    provider: '',
    minimaxToken: '',
    tgToken: '',
    tgUserId: '',
    tgLoaded: false,
    loading: false,
    alert: null,
    _alertTimer: null,
    oauth: { show: false, title: '', output: '', showOpen: false, showDone: false, openUrl: '', ws: null },

    init() {
      this.$watch('step', (val) => {
        if (val === 2) this.loadTelegramConfig();
      });
    },

    get canStep1() {
      if (this.provider === 'minimax') return !!this.minimaxToken;
      return !!this.provider;
    },
    get canStep2() {
      return !!this.tgToken.trim() && !!this.tgUserId.trim();
    },
    get step1Class() {
      return this.step > 1 || this.step === 'success' ? 'text-emerald-300' : (this.step === 1 ? 'text-indigo-300' : 'text-slate-300');
    },
    get step1NumClass() {
      return this.step > 1 || this.step === 'success' ? 'bg-emerald-500 text-white' : (this.step === 1 ? 'bg-indigo-500 text-white' : 'bg-slate-700 text-slate-100');
    },
    get step2Class() {
      return this.step === 'success' ? 'text-emerald-300' : (this.step === 2 ? 'text-indigo-300' : 'text-slate-300');
    },
    get step2NumClass() {
      return this.step === 'success' ? 'bg-emerald-500 text-white' : (this.step === 2 ? 'bg-indigo-500 text-white' : 'bg-slate-700 text-slate-100');
    },

    showAlert(type, message) {
      if (this._alertTimer) clearTimeout(this._alertTimer);
      this.alert = { type, message };
      this._alertTimer = setTimeout(() => { this.alert = null; }, 5000);
    },

    closeOAuth() {
      this.oauth.show = false;
      if (this.oauth.ws) { this.oauth.ws.close(); this.oauth.ws = null; }
    },

    async submitStep1() {
      if (!this.canStep1) return;
      this.loading = true;
      try {
        const res = await fetch('/api/config/model', {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ provider: this.provider, token: this.minimaxToken || undefined })
        });
        const result = await res.json();
        this.loading = false;
        if (result.success && result.data.requiresOAuth) {
          if (result.data.oauthMode === 'auto') this.startGptOAuth();
          else if (result.data.oauthMode === 'device') this.startQwenDevice();
          else if (result.data.manualOAuth) this.showManualOAuth(result.data.command);
          else this.startWsOAuth(this.provider);
        } else if (result.success) {
          this.showAlert('success', '模型配置成功!');
          setTimeout(() => this.step = 2, 1000);
        } else {
          this.showAlert('error', result.error || '配置失败');
        }
      } catch (err) {
        this.loading = false;
        this.showAlert('error', '网络错误: ' + err.message);
      }
    },

    async startGptOAuth() {
      this.oauth = { show: true, title: 'GPT OAuth 登录', output: '正在启动 GPT OAuth 授权...', showOpen: true, showDone: false, openUrl: '', ws: null };
      try {
        const res = await fetch('/api/config/gpt-oauth/start', { method: 'POST', headers: { 'Content-Type': 'application/json' } });
        const result = await res.json();
        if (!result.success) { this.oauth.output = '<div class="text-red-400">✗ ' + (result.error || '启动失败') + '</div>'; return; }
        const { sessionId, authUrl } = result.data;
        this.oauth.openUrl = authUrl;
        this.oauth.output = '<div style="color:#fbbf24;font-weight:bold;margin-bottom:12px">⏳ 等待授权中...</div>\\n请在浏览器中打开以下链接完成授权：\\n\\n' + authUrl + '\\n\\n<div style="color:#10b981;font-weight:bold;margin-top:12px">✓ 授权完成后将自动跳转到下一步</div>';
        window.open(authUrl, '_blank');
        this.pollOAuth('/api/config/gpt-oauth/poll', sessionId, 2000);
      } catch (err) { this.oauth.output = '<div class="text-red-400">✗ 网络错误: ' + err.message + '</div>'; }
    },

    async startQwenDevice() {
      this.oauth = { show: true, title: '千问 OAuth 登录', output: '正在请求授权链接...', showOpen: true, showDone: false, openUrl: '', ws: null };
      try {
        const res = await fetch('/api/config/qwen-oauth/start', { method: 'POST', headers: { 'Content-Type': 'application/json' } });
        const result = await res.json();
        if (!result.success) { this.oauth.output = '<div class="text-red-400">✗ ' + (result.error || '启动失败') + '</div>'; return; }
        const { sessionId, verificationUrl, userCode, interval } = result.data;
        this.oauth.openUrl = verificationUrl;
        this.oauth.output = '<div style="color:#fbbf24;font-weight:bold;margin-bottom:12px">⏳ 等待授权中...</div>\\n\\n请在浏览器打开以下链接完成授权：\\n\\n' + verificationUrl + '\\n\\n<div style="color:#8b5cf6;font-weight:bold;margin:12px 0">验证码：' + userCode + '</div>\\n\\n<div style="color:#10b981;font-weight:bold;margin-top:12px">✓ 授权完成后将自动跳转到下一步</div>';
        window.open(verificationUrl, '_blank');
        this.pollOAuth('/api/config/qwen-oauth/poll', sessionId, Math.max(2000, (interval || 2) * 1000));
      } catch (err) { this.oauth.output = '<div class="text-red-400">✗ 网络错误: ' + err.message + '</div>'; }
    },

    async pollOAuth(url, sessionId, ms) {
      try {
        const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ sessionId }) });
        const r = await res.json();
        if (r.success && r.data?.status === 'pending') { setTimeout(() => this.pollOAuth(url, sessionId, ms), ms); return; }
        if (r.success && r.data?.status === 'success') {
          this.oauth.output += '\\n<div class="text-emerald-400">✓ 登录成功</div>';
          setTimeout(() => { this.closeOAuth(); this.showAlert('success', '模型配置成功!'); setTimeout(() => this.step = 2, 1000); }, 1000);
          return;
        }
        this.oauth.output += '\\n<div class="text-red-400">✗ ' + (r.error || '登录失败') + '</div>';
      } catch { this.oauth.output += '\\n<div class="text-red-400">✗ 轮询失败</div>'; }
    },

    showManualOAuth(command) {
      this.oauth = { show: true, title: 'OAuth 登录', output: '当前环境无法创建交互式终端。\\n请在你的本地终端执行以下命令完成登录：\\n\\n' + (command || '') + '\\n\\n完成后点击"已完成登录"。', showOpen: false, showDone: true, openUrl: '', ws: null };
    },
    manualOAuthDone() {
      this.closeOAuth();
      this.showAlert('success', '模型配置完成，请继续下一步');
      setTimeout(() => this.step = 2, 500);
    },

    startWsOAuth(provider) {
      const label = provider === 'gpt' ? 'GPT' : '千问';
      this.oauth = { show: true, title: label + ' OAuth 登录', output: '正在启动 ' + label + ' OAuth 登录...\\n\\n', showOpen: false, showDone: false, openUrl: '', ws: null };
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      const ws = new WebSocket(protocol + '//' + window.location.host + '/ws/oauth-login');
      this.oauth.ws = ws;
      ws.onopen = () => ws.send(JSON.stringify({ provider }));
      ws.onmessage = (e) => {
        const d = JSON.parse(e.data);
        if (d.type === 'output') this.oauth.output += d.data;
        else if (d.type === 'success') {
          this.oauth.output += '\\n<div class="text-emerald-400">✓ ' + d.message + '</div>';
          setTimeout(() => { this.closeOAuth(); this.showAlert('success', '模型配置成功!'); setTimeout(() => this.step = 2, 1000); }, 2000);
        } else if (d.type === 'error') {
          this.oauth.output += '\\n<div class="text-red-400">✗ ' + d.message + '</div>';
          setTimeout(() => { this.closeOAuth(); this.showAlert('error', '登录失败: ' + d.message); }, 2000);
        }
      };
      ws.onerror = () => {
        this.oauth.output += '\\n<div class="text-red-400">✗ 连接错误</div>';
        setTimeout(() => { this.closeOAuth(); this.showAlert('error', 'WebSocket 连接失败'); }, 2000);
      };
    },

    async loadTelegramConfig() {
      if (this.tgLoaded) return;
      this.tgLoaded = true;
      try {
        const res = await fetch('/api/config/telegram');
        const r = await res.json();
        if (r.success && r.data.configured) {
          this.tgToken = r.data.botToken || '';
          this.tgUserId = r.data.userId || '';
        }
      } catch {}
    },

    async submitStep2() {
      if (!this.tgToken.trim() || !this.tgUserId.trim()) return;
      this.loading = true;
      try {
        const res = await fetch('/api/config/telegram', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ token: this.tgToken.trim(), userId: this.tgUserId.trim() }) });
        const r = await res.json();
        if (r.success) { this.showAlert('success', 'Telegram 配置成功!'); setTimeout(() => this.step = 'success', 1000); }
        else this.showAlert('error', r.error || '配置失败');
      } catch (err) { this.showAlert('error', '网络错误: ' + err.message); }
      finally { this.loading = false; }
    },

    async skipTelegram() {
      this.loading = true;
      try {
        const res = await fetch('/api/config/telegram', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ skip: true }) });
        const r = await res.json();
        if (r.success) { this.showAlert('success', '已跳过 Telegram 配置'); setTimeout(() => this.step = 'success', 1000); }
        else this.showAlert('error', r.error || '操作失败');
      } catch (err) { this.showAlert('error', '网络错误: ' + err.message); }
      finally { this.loading = false; }
    },

    async openDashboard() {
      try {
        const res = await fetch('/api/config/status');
        const r = await res.json();
        if (r.success && r.data.gatewayRunning) {
          let url = 'http://127.0.0.1:18789';
          if (r.data.gatewayToken) url += '?token=' + encodeURIComponent(r.data.gatewayToken);
          window.open(url, '_blank');
        } else {
          this.showAlert('error', 'Gateway 未运行,请先启动 Gateway');
        }
      } catch { window.open('http://127.0.0.1:18789', '_blank'); }
    }
  }))
})
`;var dr=Object.freeze,uo=Object.defineProperty,ho=(e,t)=>dr(uo(e,"raw",{value:dr(e.slice())})),ur;const po=sn(e=>{const t=Is({withTokenInput:!0,alpineTokenModel:"tgToken"});return e.render(Ss(ur||(ur=ho([`
    <div x-data="wizard">

      <!-- OAuth 弹窗 -->
      <div x-show="oauth.show" x-cloak class="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/70">
        <div class="w-full max-w-2xl rounded-2xl bg-slate-900 text-slate-100 shadow-2xl">
          <div class="flex items-center justify-between border-b border-slate-700 px-5 py-3">
            <div class="text-sm" x-text="oauth.title"></div>
            <button class="text-xl text-slate-400 hover:text-white" @click="closeOAuth()">×</button>
          </div>
          <div class="max-h-[520px] overflow-y-auto px-5 py-4 font-mono text-sm">
            <div class="whitespace-pre-wrap" x-html="oauth.output"></div>
            <div class="mt-4 flex justify-end gap-2">
              <button x-show="oauth.showOpen" @click="window.open(oauth.openUrl,'_blank')" class="rounded-lg border border-slate-600 px-4 py-2 text-sm text-slate-200 hover:bg-slate-800">打开授权页面</button>
              <button x-show="oauth.showDone" @click="manualOAuthDone()" class="rounded-lg bg-indigo-500 px-4 py-2 text-sm text-white hover:bg-indigo-400">已完成登录</button>
            </div>
          </div>
        </div>
      </div>

      <div class="h-screen w-full flex items-center justify-center p-6 overflow-hidden">
        <div class="w-full max-w-5xl rounded-3xl bg-white/95 p-10 shadow-2xl overflow-y-auto max-h-[calc(100vh-3rem)]">

          <!-- 标题 -->
          <div class="text-center">
            <h1 class="text-3xl font-semibold text-indigo-500">OpenClaw 配置助手</h1>
            <p class="mt-2 text-sm text-slate-500">按照步骤完成模型和 Telegram 配置</p>
          </div>

          <!-- 步骤指示器 -->
          <div class="mt-10 flex items-center justify-center gap-6 text-sm">
            <div class="flex items-center gap-3" :class="step1Class">
              <div class="flex h-10 w-10 items-center justify-center rounded-full" :class="step1NumClass">1</div>
              <span>选择模型</span>
            </div>
            <div class="h-[2px] w-12 bg-slate-200"></div>
            <div class="flex items-center gap-3" :class="step2Class">
              <div class="flex h-10 w-10 items-center justify-center rounded-full" :class="step2NumClass">2</div>
              <span>配置 Telegram</span>
            </div>
          </div>

          <!-- 提示 -->
          <div x-show="alert && alert.type === 'error'" x-cloak x-text="alert?.message" class="mt-8 rounded-xl border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700"></div>
          <div x-show="alert && alert.type === 'success'" x-cloak x-text="alert?.message" class="mt-8 rounded-xl border border-emerald-200 bg-emerald-50 px-4 py-3 text-sm text-emerald-700"></div>

          <!-- Loading -->
          <div x-show="loading" x-cloak class="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/40">
            <div class="rounded-2xl bg-white px-6 py-5 text-center shadow-xl">
              <div class="mx-auto mb-3 h-10 w-10 animate-spin rounded-full border-4 border-slate-200 border-t-indigo-500"></div>
              <p class="text-sm text-slate-600">正在配置中,请稍候...</p>
            </div>
          </div>

          <!-- 步骤 1: 选择模型 -->
          <div x-show="step === 1" class="mt-10">
            <h2 class="mb-6 text-xl font-semibold text-slate-700">步骤 1: 选择模型</h2>
            <div>
              <label class="mb-2 block text-sm font-medium text-slate-600">选择模型提供商</label>
              <select x-model="provider" class="w-full rounded-xl border border-slate-200 bg-white px-4 py-3 text-sm text-slate-700 focus:border-indigo-400 focus:outline-none">
                <option value="">-- 请选择 --</option>
                <option value="minimax">MiniMax (需要 API Key)</option>
                <option value="gpt">GPT (通过 OAuth 登录)</option>
                <option value="qwen">千问 (通过 OAuth 登录)</option>
              </select>
            </div>
            <div x-show="provider === 'minimax'" x-cloak class="mt-6">
              <label class="mb-2 block text-sm font-medium text-slate-600">MiniMax API Key</label>
              <input type="text" x-model="minimaxToken" placeholder="请输入 MiniMax API Key" class="w-full rounded-xl border border-slate-200 bg-white px-4 py-3 text-sm text-slate-700 focus:border-indigo-400 focus:outline-none" />
            </div>
            <div class="mt-8 flex justify-end">
              <button @click="submitStep1()" :disabled="!canStep1" class="rounded-lg bg-indigo-500 px-5 py-2 text-sm text-white hover:bg-indigo-400 disabled:bg-slate-200 disabled:text-slate-400">下一步</button>
            </div>
          </div>

          <!-- 步骤 2: 配置 Telegram -->
          <div x-show="step === 2" x-cloak class="mt-10">
            <h2 class="mb-6 text-xl font-semibold text-slate-700">步骤 2: 配置 Telegram 机器人</h2>
            `,`
            <div class="mt-6">
              <label class="mb-2 block text-sm font-medium text-slate-600">Telegram 用户 ID</label>
              <input type="text" x-model="tgUserId" placeholder="请输入用户 ID" class="w-full rounded-xl border border-slate-200 bg-white px-4 py-3 text-sm text-slate-700 focus:border-indigo-400 focus:outline-none" />
            </div>
            <div class="mt-8 flex justify-between gap-3">
              <button @click="step = 1" class="rounded-lg border border-slate-200 px-5 py-2 text-sm text-slate-600 hover:bg-slate-100">上一步</button>
              <div class="flex gap-3">
                <button @click="skipTelegram()" class="rounded-lg bg-slate-100 px-5 py-2 text-sm text-slate-600 hover:bg-slate-200">跳过</button>
                <button @click="submitStep2()" :disabled="!tgToken.trim() || !tgUserId.trim()" class="rounded-lg bg-indigo-500 px-5 py-2 text-sm text-white hover:bg-indigo-400 disabled:bg-slate-200 disabled:text-slate-400">完成配置</button>
              </div>
            </div>
          </div>

          <!-- 配置完成 -->
          <div x-show="step === 'success'" x-cloak class="mt-10">
            <div class="text-center">
              <div class="mx-auto flex h-20 w-20 items-center justify-center rounded-full bg-emerald-500 text-3xl text-white">✓</div>
              <h2 class="mt-4 text-2xl font-semibold text-slate-700">配置完成!</h2>
              <p class="mt-2 text-sm text-slate-500">OpenClaw 已成功配置并启动。</p>
              <p class="mt-3 text-sm font-semibold text-slate-600">现在可以打开 OpenClaw 页面，并在 Telegram 里向机器人发送消息测试。</p>
              <div class="mx-auto mt-6 max-w-md text-left text-sm text-slate-500">
                <p class="mb-2">✓ 打开 OpenClaw Dashboard 开始使用</p>
                <p class="mb-2">✓ 在 Telegram 中向您的机器人发送消息测试</p>
                <p>✓ 查看日志: <code class="rounded bg-slate-100 px-2 py-1 text-xs text-slate-600">tail -f ~/.openclaw/logs/gateway.log</code></p>
              </div>
              <div class="mt-6 flex flex-wrap justify-center gap-3">
                <button @click="openDashboard()" class="rounded-lg bg-indigo-500 px-5 py-2 text-sm text-white hover:bg-indigo-400">开始体验 OpenClaw</button>
                <a class="rounded-lg border border-slate-200 px-5 py-2 text-sm text-slate-600 hover:bg-slate-100" href="/config">更多配置指引</a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script>`,`<\/script>
    `])),t,X(co)),{title:"OpenClaw 配置助手"})}),fo=Object.freeze(Object.defineProperty({__proto__:null,default:po},Symbol.toStringTag,{value:"Module"})),Ne="__importing_islands",mo=new An,cs=e=>(e=e.replace(/\.tsx?$/g,"").replace(/\.mdx?$/g,"").replace(/^\/?index$/,"/").replace(/\/index$/,"").replace(/\[\.{3}.+\]/,"*").replace(/\((.+?)\)/g,"").replace(/\[(.+?)\]/g,":$1").replace(/\/\/+/g,"/"),e.startsWith("/")?e:"/"+e),ds=e=>{const t={};for(const[s,r]of Object.entries(e)){const n=s.split("/"),a=n.pop(),o=n.join("/");t[o]||(t[o]={}),a&&(t[o][a]=r)}for(const[s,r]of Object.entries(t)){const n=Object.entries(r).sort(([a],[o])=>a[0]==="["&&o[0]!=="["?1:a[0]!=="["&&o[0]==="["?-1:a.localeCompare(o));t[s]=Object.fromEntries(n)}return t},go=e=>Object.keys(e).sort((s,r)=>{const n=s.split("/").length,a=r.split("/").length;return n-a||r.localeCompare(s)}).map(s=>({[s]:e[s]})),xo=e=>{const t={};for(const r of Object.keys(e)){const n=r.split("/");n.pop();const a=n.join("/");t[a]||(t[a]=[]),t[a].includes(r)||t[a].push(r)}const s=Object.keys(t).sort((r,n)=>n.length-r.length);for(const r of s)for(const n of s)if(n.startsWith(r)&&n!==r){const a=new Set([...t[n],...t[r]]);t[n]=[...a]}return t},rn="_404.tsx",wo="_error.tsx",bo=["GET","POST","PUT","DELETE","OPTIONS","PATCH"],vo=e=>{var P;const t=e.root,s=new RegExp(`^${t}`),r=z=>cs(z.replace(s,"")),n=e.app??new Ae,a=e.trailingSlash??!1,o=new Map,i=new WeakSet,c=new WeakMap,d=new WeakMap;n.use(async function(C,N){await mo.run(C,()=>N())}),e.init&&e.init(n);const u=e.NOT_FOUND,p=ds(u),f=e.ERROR,m=ds(f),w=e.RENDERER,v=xo(w),g=e.MIDDLEWARE,b=e.ROUTES,O=go(ds(b)),S=(z,C)=>{let N=C[z]??[];const j=F=>(N=C[F.join("/")],N||(F.pop(),F.length&&j(F)),N??[]),Le=z.split("/");return N=j(Le),N.sort((F,ke)=>F.split("/").length-ke.split("/").length),N},k={};for(const z of O)for(const[C,N]of Object.entries(z)){const j=new Ae;let Le=!1;const F=yo(C,p);F&&j.use(async(_,I)=>{if(await I(),_.res.status===404&&!i.has(_.res)){const G=await F(_),D=new Response(G.body,{status:404,headers:G.headers});_.res=D,i.add(_.res)}});const ke=_=>_.replaceAll("[","\\[").replaceAll("]","\\]").replaceAll("(","\\(").replaceAll(")","\\)"),Vt=_=>Object.keys(g).find(I=>new RegExp(ke(_)+"/_middleware.tsx?").test(I)),vn=(_,I)=>{const G=I.split("/"),D=[];for(let M=G.length-1;M>0;M--)D.push(G.slice(0,M).join("/"));return D.some(M=>{var L;return(L=o.get(M))==null?void 0:L.has(_)})},Us=_=>{const G=!C.replace(s,"").includes("/"),D=!Object.keys(N).some(M=>M.includes("/"));Object.keys(N).length>0&&G&&D&&(j.use("/",..._),Object.keys(N).forEach(M=>{const L=cs(M);L!=="/"&&!L.includes("[")&&!L.includes("*")&&j.use(L,..._)}))};S(C,v).map(_=>{const I=w[_];I[Ne]&&(Le=!0);const D=I.default;if(D){c.has(D)||c.set(D,new WeakSet);const M=c.get(D),L=ls(async(J,V)=>M.has(J.req.raw)?V():(M.add(J.req.raw),D(J,V)));j.use("*",L),Us([L])}});let $e=Vt(C);if(!$e){const _=C.split("/");for(let I=_.length-1;I>=0;I--){const G=_.slice(0,I).join("/");if(!G.includes(t))break;const D=Vt(G);if(D&&!vn(D,C)){$e=D;break}}}if($e){const _=g[$e],I=$e.replace("/_middleware.tsx","").replace("/_middleware.ts",""),G=I===C||C.startsWith(I+"/");if(_.default&&G){const D=_.default.map(M=>{d.has(M)||d.set(M,new WeakSet);const L=d.get(M);return ls(async(J,V)=>L.has(J.req.raw)?V():(L.add(J.req.raw),M(J,V)))});j.use("*",...D),Us(D),o.has(C)||o.set(C,new Set),(P=o.get(C))==null||P.add($e)}}for(const[_,I]of Object.entries(N)){const G=I[Ne],D=ls(async function(V,yn){V.set(Ne,G?!0:Le),await yn()}),M=I.default,L=cs(_);M&&"fetch"in M&&(j.use(D),j.route(L,M));for(const J of bo){const V=I[J];V&&(j.on(J,L,D),j.on(J,L,...V))}M&&Array.isArray(M)&&(j.get(L,D),j.get(L,...M)),typeof M=="function"&&(j.get(L,D),j.get(L,async J=>{const V=await M(J);return V instanceof Response?V:J.render(V,I)}))}const qs=To(C,m);qs&&(k[C]=qs);for(const[_,I]of Object.entries(k))new RegExp(`^${_}`).test(C)&&I&&j.onError(I);let it=r(C);a&&(it=it.endsWith("/")?it:it+"/"),n.route(it,j)}for(const z of O.reverse()){const C=Object.entries(z)[0][0],N=new Ae;Oo(N,C,p,i);const j=r(C);n.route(j,N)}return n};function yo(e,t){for(const[s,r]of Object.entries(t))if(e===s){const n=r[rn];if(n)return n.default}}function Oo(e,t,s,r){for(const[n,a]of Object.entries(s))if(t===n){const o=a[rn];if(o){const i=o.default;o[Ne]&&e.use("*",(d,u)=>(d.set(Ne,!0),u())),e.get("*",async(d,u)=>{await u(),r.has(d.res)&&(d.status(404),r.add(d.res),d.res=await i(d))})}}}function To(e,t){for(const[s,r]of Object.entries(t))if(e===s){const n=r[wo];if(n){const a=n.default;if(a)return async(i,c)=>{const d=n[Ne];return d&&c.set(Ne,d),c.status(500),a(i,c)}}}}const Ao=e=>{const t={root:(e==null?void 0:e.root)??"/app/routes",app:e==null?void 0:e.app,init:e==null?void 0:e.init,trailingSlash:e==null?void 0:e.trailingSlash,NOT_FOUND:(e==null?void 0:e.NOT_FOUND)??Object.assign({}),ERROR:(e==null?void 0:e.ERROR)??Object.assign({}),RENDERER:(e==null?void 0:e.RENDERER)??Object.assign({"/app/routes/_renderer.tsx":Za}),MIDDLEWARE:(e==null?void 0:e.MIDDLEWARE)??Object.assign({}),ROUTES:(e==null?void 0:e.ROUTES)??Object.assign({"/app/routes/config.tsx":lo,"/app/routes/index.tsx":fo})};return vo(t)};var ko=e=>{const s={...{origin:"*",allowMethods:["GET","HEAD","PUT","POST","DELETE","PATCH"],allowHeaders:[],exposeHeaders:[]},...e},r=(a=>typeof a=="string"?a==="*"?()=>a:o=>a===o?o:null:typeof a=="function"?a:o=>a.includes(o)?o:null)(s.origin),n=(a=>typeof a=="function"?a:Array.isArray(a)?()=>a:()=>[])(s.allowMethods);return async function(o,i){var u;function c(p,f){o.res.headers.set(p,f)}const d=await r(o.req.header("origin")||"",o);if(d&&c("Access-Control-Allow-Origin",d),s.credentials&&c("Access-Control-Allow-Credentials","true"),(u=s.exposeHeaders)!=null&&u.length&&c("Access-Control-Expose-Headers",s.exposeHeaders.join(",")),o.req.method==="OPTIONS"){s.origin!=="*"&&c("Vary","Origin"),s.maxAge!=null&&c("Access-Control-Max-Age",s.maxAge.toString());const p=await n(o.req.header("origin")||"",o);p.length&&c("Access-Control-Allow-Methods",p.join(","));let f=s.allowHeaders;if(!(f!=null&&f.length)){const m=o.req.header("Access-Control-Request-Headers");m&&(f=m.split(/\s*,\s*/))}return f!=null&&f.length&&(c("Access-Control-Allow-Headers",f.join(",")),o.res.headers.append("Vary","Access-Control-Request-Headers")),o.res.headers.delete("Content-Length"),o.res.headers.delete("Content-Type"),new Response(null,{headers:o.res.headers,status:204,statusText:"No Content"})}await i(),s.origin!=="*"&&o.header("Vary","Origin",{append:!0})}};function nn(e){return e.replace(/\x1B(?:[@-Z\\-_]|\[[0-?]*[ -/]*[@-~])/g,"")}function Ke(e){const s=nn(e).split(`
`).map(r=>r.trim()).filter(Boolean);return s.length?s[s.length-1]:""}function pe(e){const t=nn(e),s=t.indexOf("{"),r=t.lastIndexOf("}");if(s===-1||r===-1||r<=s)return null;try{return JSON.parse(t.slice(s,r+1))}catch{return null}}async function vs(e,t={},s=6e4){try{const{stdout:r}=await T("openclaw",["gateway","call",e,"--params",JSON.stringify(t),"--json","--timeout",String(s)]),n=pe(r);if(n===null)throw new Error("Gateway 返回了无效的响应");return n}catch(r){const n=r.stderr||"",a=r.stdout||"",i=(n+`
`+a).match(/Error:\s*(.+)/i);throw i?new Error(i[1].trim()):new Error(r.message||"Gateway 调用失败")}}const B=new Ae,an="https://chat.qwen.ai",Eo=`${an}/api/v1/oauth2/device/code`,So=`${an}/api/v1/oauth2/token`,on="f0304373b74a44d2b584a3fb70ca9e56",jo="openid profile email model.completion",Ro="urn:ietf:params:oauth:grant-type:device_code",Co="https://portal.qwen.ai/v1",Po="qwen-portal/coder-model",hr="openai-codex/gpt-5.2",Ft=new Map,Oe=new Map;let Pt=null;const _o="node_modules/@mariozechner/pi-ai/dist/utils/oauth/openai-codex.js";async function Mo(){const e=process.env.HOME||"";try{const{stdout:r}=await T("which",["openclaw"]),n=r.trim();try{const o=E.readFileSync(n,"utf-8").match(/exec\s+(.+?)\/bin\/openclaw/);if(o){const i=o[1].trim(),c=U.join(i,"lib/node_modules/openclaw");if(E.existsSync(c))return c}}catch{}try{const a=E.realpathSync(n),o=U.resolve(U.dirname(a),"..","lib/node_modules/openclaw");if(E.existsSync(o))return o}catch{}}catch{}const t=U.join(e,".nvm/versions/node");try{if(E.existsSync(t)){const r=E.readdirSync(t).sort().reverse();for(const n of r){const a=U.join(t,n,"lib/node_modules/openclaw");if(E.existsSync(a))return a}}}catch{}const s=[U.join(e,".local/lib/node_modules/openclaw"),"/usr/local/lib/node_modules/openclaw","/usr/lib/node_modules/openclaw"];for(const r of s)if(E.existsSync(r))return r;return null}async function Io(){if(Pt)return Pt;const e=await Mo();if(!e)throw new Error("无法找到 openclaw 安装目录，请确认 openclaw 已正确安装");const t=U.join(e,_o);if(!E.existsSync(t))throw new Error(`找到 openclaw 目录 (${e}) 但缺少 pi-ai 模块: ${t}`);try{return Pt=(await import(`file://${t}`)).loginOpenAICodex,console.log(`已加载 loginOpenAICodex from: ${t}`),Pt}catch(s){throw new Error(`加载 loginOpenAICodex 失败: ${s.message}`)}}function Do(e){var i,c;const t=process.env.HOME||process.cwd(),s=((i=process.env.OPENCLAW_AGENT_DIR)==null?void 0:i.trim())||U.join(t,".openclaw","agents","main","agent"),r=U.join(s,"auth-profiles.json");let n={version:1,profiles:{}};try{E.existsSync(r)&&(n=JSON.parse(E.readFileSync(r,"utf-8")))}catch{}const a=`openai-codex:${((c=e.email)==null?void 0:c.trim())||"default"}`;n.profiles[a]={type:"oauth",provider:"openai-codex",...e};const o=U.dirname(r);E.existsSync(o)||E.mkdirSync(o,{recursive:!0}),E.writeFileSync(r,JSON.stringify(n,null,2)),console.log(`OpenAI Codex 凭据已写入 ${r} (profile: ${a})`)}async function No(){await Ds({[hr]:{}}),await T("openclaw",["config","set","--json","agents.defaults.model",JSON.stringify({primary:hr})])}function ln(e){return Object.entries(e).map(([t,s])=>`${encodeURIComponent(t)}=${encodeURIComponent(s)}`).join("&")}function Ho(){const e=kn(32).toString("base64url"),t=En("sha256").update(e).digest("base64url");return{verifier:e,challenge:t}}function Lo(e){const t=(e==null?void 0:e.trim())||Co,s=t.startsWith("http")?t:`https://${t}`;return s.endsWith("/v1")?s:`${s.replace(/\/+$/,"")}/v1`}async function $o(e){const t=await fetch(Eo,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded",Accept:"application/json","x-request-id":ks()},body:ln({client_id:on,scope:jo,code_challenge:e.challenge,code_challenge_method:"S256"})});if(!t.ok){const r=await t.text();throw new Error(`Qwen device authorization failed: ${r||t.statusText}`)}const s=await t.json();if(!s.device_code||!s.user_code||!s.verification_uri)throw new Error(s.error??"Qwen device authorization returned an incomplete payload (missing user_code or verification_uri).");return s}async function Uo(e){const t=await fetch(So,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded",Accept:"application/json"},body:ln({grant_type:Ro,client_id:on,device_code:e.deviceCode,code_verifier:e.verifier})});if(!t.ok){let r;try{r=await t.json()}catch{return{status:"error",message:await t.text()||t.statusText}}return(r==null?void 0:r.error)==="authorization_pending"?{status:"pending"}:(r==null?void 0:r.error)==="slow_down"?{status:"pending",slowDown:!0}:{status:"error",message:(r==null?void 0:r.error_description)||(r==null?void 0:r.error)||t.statusText}}const s=await t.json();return!s.access_token||!s.refresh_token||!s.expires_in?{status:"error",message:"Qwen OAuth returned incomplete token payload."}:{status:"success",token:{access:s.access_token,refresh:s.refresh_token,expires:Date.now()+s.expires_in*1e3,resourceUrl:s.resource_url}}}function qo(){const e=process.env.HOME||process.cwd(),t=process.env.OPENCLAW_OAUTH_DIR||U.join(e,".openclaw","credentials");return U.join(t,"oauth.json")}function cn(){const e=process.env.HOME||process.cwd();return U.join(e,".openclaw-helper","remote-support.json")}async function Ds(e){let t={};try{const{stdout:r}=await T("openclaw",["config","get","--json","agents.defaults.models"]);t=pe(r)||{}}catch{t={}}const s={...t,...e};await T("openclaw",["config","set","--json","agents.defaults.models",JSON.stringify(s)])}function Fo(e){const t=qo(),s=U.dirname(t);E.existsSync(s)||E.mkdirSync(s,{recursive:!0});let r={};try{r=JSON.parse(E.readFileSync(t,"utf-8"))}catch{r={}}r["qwen-portal"]={access:e.access,refresh:e.refresh,expires:e.expires,...e.resourceUrl?{resourceUrl:e.resourceUrl}:{}},E.writeFileSync(t,JSON.stringify(r,null,2))}async function Wo(e){const t=Lo(e);await T("openclaw",["config","set","--json","models.providers.qwen-portal",JSON.stringify({baseUrl:t,apiKey:"qwen-oauth",api:"openai-completions",models:[{id:"coder-model",name:"Qwen Coder",reasoning:!1,input:["text"],cost:{input:0,output:0,cacheRead:0,cacheWrite:0},contextWindow:128e3,maxTokens:8192},{id:"vision-model",name:"Qwen Vision",reasoning:!1,input:["text","image"],cost:{input:0,output:0,cacheRead:0,cacheWrite:0},contextWindow:128e3,maxTokens:8192}]})]),await Ds({"qwen-portal/coder-model":{alias:"qwen"},"qwen-portal/vision-model":{}}),await T("openclaw",["config","set","--json","agents.defaults.model",JSON.stringify({primary:Po})])}B.post("/model",async e=>{try{const{provider:t,token:s}=await e.req.json();if(!t)return e.json({success:!1,error:"请选择模型提供商"},400);let r;switch(t){case"minimax":if(!s)return e.json({success:!1,error:"请提供 MiniMax API Key"},400);process.env.MINIMAX_API_KEY=s,await T("openclaw",["config","set","--json","models.providers.minimax",JSON.stringify({baseUrl:"https://api.minimax.io/anthropic",api:"anthropic-messages",apiKey:"${MINIMAX_API_KEY}",models:[{id:"MiniMax-M2.1",name:"MiniMax M2.1",reasoning:!1,input:["text"],cost:{input:15,output:60,cacheRead:2,cacheWrite:10},contextWindow:2e5,maxTokens:8192}]})]),await Ds({"minimax/MiniMax-M2.1":{}}),await T("openclaw",["config","set","--json","agents.defaults.model",JSON.stringify({primary:"minimax/MiniMax-M2.1"})]);const n=`${process.env.HOME}/.profile`,a=`export MINIMAX_API_KEY="${s}"`;try{const{stdout:o}=await T("grep",["-q","MINIMAX_API_KEY",n])}catch{await T("sh",["-c",`echo '' >> ${n} && echo '# OpenClaw MiniMax API Key' >> ${n} && echo '${a}' >> ${n}`])}r={provider:"minimax",model:"MiniMax-M2.1"};break;case"gpt":r={provider:"gpt",requiresOAuth:!0,oauthMode:"auto"};break;case"qwen":await T("openclaw",["plugins","enable","qwen-portal-auth"]),r={provider:"qwen",requiresOAuth:!0,oauthMode:"device"};break;default:return e.json({success:!1,error:"不支持的模型提供商"},400)}return e.json({success:!0,data:r})}catch(t){return console.error("配置模型失败:",t),e.json({success:!1,error:"配置失败: "+(t.message||"未知错误")},500)}});B.post("/qwen-oauth/start",async e=>{try{const{verifier:t,challenge:s}=Ho(),r=await $o({challenge:s}),n=ks(),a=Date.now()+r.expires_in*1e3,o=(r.interval??2)*1e3;return Ft.set(n,{sessionId:n,deviceCode:r.device_code,verifier:t,expiresAt:a,intervalMs:o}),e.json({success:!0,data:{sessionId:n,verificationUrl:r.verification_uri_complete||r.verification_uri,userCode:r.user_code,expiresIn:r.expires_in,interval:r.interval??2}})}catch(t){return console.error("启动千问 OAuth 失败:",t),e.json({success:!1,error:"启动千问 OAuth 失败: "+(t.message||"未知错误")},500)}});B.post("/gpt-oauth/start",async e=>{try{const t=await Io(),s=ks(),r={sessionId:s,status:"pending",startedAt:Date.now()};return Oe.set(s,r),t({onAuth:a=>{const o=Oe.get(s);o&&(o.authUrl=a.url)},onPrompt:async a=>(console.log("OpenAI OAuth prompt:",a.message),""),onProgress:a=>{console.log("OpenAI OAuth progress:",a)}}).then(async a=>{const o=Oe.get(s);if(o)try{Do(a),await No(),o.status="success",console.log("OpenAI Codex OAuth 认证成功")}catch(i){o.status="error",o.error="保存凭据失败: "+(i.message||"未知错误"),console.error("保存 OpenAI Codex 凭据失败:",i)}}).catch(a=>{const o=Oe.get(s);o&&(o.status="error",o.error="ChatGPT OAuth 失败: "+(a.message||"未知错误")),console.error("OpenAI Codex OAuth 失败:",a)}),await new Promise(a=>setTimeout(a,3e3)),r.authUrl||""||await new Promise(a=>setTimeout(a,2e3)),e.json({success:!0,data:{sessionId:s,authUrl:r.authUrl||"https://chatgpt.com",message:"请在浏览器中完成 ChatGPT 授权"}})}catch(t){return console.error("启动 GPT OAuth 失败:",t),e.json({success:!1,error:"启动 GPT OAuth 失败: "+(t.message||"未知错误")},500)}});B.post("/gpt-oauth/poll",async e=>{try{const{sessionId:t}=await e.req.json(),s=Oe.get(t);return s?Date.now()-s.startedAt>300*1e3?(Oe.delete(t),e.json({success:!1,error:"登录已超时，请重新开始"},400)):s.status==="pending"?e.json({success:!0,data:{status:"pending"}}):s.status==="error"?(Oe.delete(t),e.json({success:!1,error:s.error||"认证失败"},500)):(Oe.delete(t),e.json({success:!0,data:{status:"success"}})):e.json({success:!1,error:"无效的会话，请重新开始登录"},400)}catch(t){return console.error("轮询 GPT OAuth 失败:",t),e.json({success:!1,error:"轮询失败: "+(t.message||"未知错误")},500)}});B.post("/qwen-oauth/poll",async e=>{try{const{sessionId:t}=await e.req.json(),s=Ft.get(t);if(!s)return e.json({success:!1,error:"无效的会话，请重新开始登录"},400);if(Date.now()>s.expiresAt)return Ft.delete(t),e.json({success:!1,error:"登录已过期，请重新开始"},400);const r=await Uo({deviceCode:s.deviceCode,verifier:s.verifier});return r.status==="pending"?e.json({success:!0,data:{status:"pending"}}):r.status==="error"?e.json({success:!1,error:r.message},500):(Fo(r.token),await Wo(r.token.resourceUrl),Ft.delete(t),e.json({success:!0,data:{status:"success"}}))}catch(t){return console.error("轮询千问 OAuth 失败:",t),e.json({success:!1,error:"轮询千问 OAuth 失败: "+(t.message||"未知错误")},500)}});B.get("/telegram",async e=>{try{let t="",s="";try{const{stdout:r}=await T("openclaw",["config","get","channels.telegram.botToken"]);t=Ke(r).replace(/^"|"$/g,"")}catch{}try{const{stdout:r}=await T("openclaw",["config","get","--json","channels.telegram.allowFrom"]),n=pe(r);Array.isArray(n)&&n.length>0&&(s=String(n[0]))}catch{}return e.json({success:!0,data:{configured:!!(t&&s),botToken:t,userId:s}})}catch{return e.json({success:!0,data:{configured:!1,botToken:"",userId:""}})}});B.post("/telegram",async e=>{try{const{token:t,userId:s,skip:r}=await e.req.json();if(r)return e.json({success:!0,skipped:!0});if(!t||!s)return e.json({success:!1,error:"请提供 Telegram Bot Token 和用户 ID"},400);await T("openclaw",["config","set","--json","channels.telegram.botToken",JSON.stringify(t)]),await T("openclaw",["config","set","--json","channels.telegram.allowFrom",JSON.stringify([s])]);try{await T("pkill",["-f","openclaw.*gateway"]),await new Promise(a=>setTimeout(a,2e3))}catch{}const n=`${process.env.HOME}/.openclaw/logs/gateway.log`;return T("sh",["-c",`nohup openclaw gateway run --bind loopback --port 18789 > ${n} 2>&1 &`]),await new Promise(a=>setTimeout(a,3e3)),e.json({success:!0,data:{token:t.substring(0,10)+"...",userId:s}})}catch(t){return console.error("配置 Telegram 失败:",t),e.json({success:!1,error:"配置失败: "+(t.message||"未知错误")},500)}});B.get("/status",async e=>{try{const t={};try{const{stdout:s}=await T("openclaw",["config","get","agents.defaults.model.primary"]);t.defaultModel=Ke(s)}catch{t.defaultModel=null}try{const{stdout:s}=await T("openclaw",["config","get","channels.telegram.botToken"]);t.telegramConfigured=!!Ke(s)}catch{t.telegramConfigured=!1}try{const{stdout:s}=await T("openclaw",["config","get","gateway.auth.token"]);t.gatewayToken=Ke(s)||null}catch{t.gatewayToken=null}try{await T("pgrep",["-f","openclaw.*gateway"]),t.gatewayRunning=!0}catch{t.gatewayRunning=!1}return e.json({success:!0,data:t})}catch(t){return console.error("获取状态失败:",t),e.json({success:!1,error:"获取状态失败: "+(t.message||"未知错误")},500)}});B.get("/models",async e=>{try{const{stdout:t}=await T("openclaw",["config","get","--json","models.providers"]),s=pe(t)||{};let r=null;try{const{stdout:a}=await T("openclaw",["config","get","agents.defaults.model.primary"]);r=Ke(a)||null}catch{r=null}const n=[];return Object.entries(s).forEach(([a,o])=>{(Array.isArray(o==null?void 0:o.models)?o.models:[]).forEach(c=>{const d=(c==null?void 0:c.id)||(c==null?void 0:c.name)||"unknown",u=(c==null?void 0:c.name)||(c==null?void 0:c.id)||d;n.push({key:`${a}/${d}`,label:`${u} (${a})`})})}),e.json({success:!0,data:{models:n,defaultModel:r}})}catch(t){return e.json({success:!1,error:"获取模型列表失败: "+(t.message||"未知错误")},500)}});B.post("/models/default",async e=>{try{const{model:t}=await e.req.json();return t?(await T("openclaw",["config","set","--json","agents.defaults.model",JSON.stringify({primary:t})]),e.json({success:!0})):e.json({success:!1,error:"缺少模型参数"},400)}catch(t){return e.json({success:!1,error:"切换默认模型失败: "+(t.message||"未知错误")},500)}});B.get("/channels",async e=>{try{const{stdout:t}=await T("openclaw",["config","get","--json","channels"]),s=pe(t)||{},r=Object.entries(s).map(([n,a])=>({id:n,label:n.toUpperCase(),enabled:(a==null?void 0:a.enabled)!==!1}));return e.json({success:!0,data:{channels:r}})}catch(t){return e.json({success:!1,error:"获取渠道配置失败: "+(t.message||"未知错误")},500)}});B.post("/whatsapp/link/start",async e=>{try{try{console.log("WhatsApp: 正在注销旧会话...");const s=await vs("channels.logout",{channel:"whatsapp",accountId:"default"},15e3);console.log("WhatsApp: 注销结果:",JSON.stringify(s))}catch(s){console.log("WhatsApp: 注销跳过 (可能无旧会话):",s.message)}console.log("WhatsApp: 正在生成 QR 码...");const t=await vs("web.login.start",{accountId:"default",force:!0,timeoutMs:3e4,verbose:!1},45e3);return e.json({success:!0,data:{qrDataUrl:t.qrDataUrl,message:t.message||"请使用 WhatsApp 扫描二维码"}})}catch(t){return console.error("WhatsApp QR 链接启动失败:",t),e.json({success:!1,error:"WhatsApp 链接启动失败: "+(t.message||"未知错误")},500)}});B.post("/whatsapp/link/poll",async e=>{try{const t=await vs("web.login.wait",{accountId:"default",timeoutMs:8e3},15e3);return e.json({success:!0,data:{connected:!!t.connected,message:t.message||""}})}catch(t){return console.error("WhatsApp QR 链接轮询失败:",t),e.json({success:!1,error:"WhatsApp 链接状态查询失败: "+(t.message||"未知错误")},500)}});B.get("/remote-support",async e=>{try{const t=cn();if(!E.existsSync(t))return e.json({success:!0,data:{sshKey:"",cpolarToken:"",region:"en"}});const s=E.readFileSync(t,"utf-8"),r=JSON.parse(s);return e.json({success:!0,data:{sshKey:r.sshKey||"",cpolarToken:r.cpolarToken||"",region:r.region||"en"}})}catch(t){return e.json({success:!1,error:"读取远程支持配置失败: "+(t.message||"未知错误")},500)}});B.post("/remote-support",async e=>{try{const{sshKey:t,cpolarToken:s,region:r}=await e.req.json(),n=cn(),a=U.dirname(n);return E.existsSync(a)||E.mkdirSync(a,{recursive:!0}),E.writeFileSync(n,JSON.stringify({sshKey:t||"",cpolarToken:s||"",region:r||"en"},null,2)),e.json({success:!0})}catch(t){return e.json({success:!1,error:"保存远程支持配置失败: "+(t.message||"未知错误")},500)}});B.post("/remote-support/start",async e=>{try{const{sshKey:t,cpolarToken:s,region:r}=await e.req.json();if(!t||!s)return e.json({success:!1,error:"请填写 SSH Key 和 cpolar AuthToken"},400);const n=r==="en"?"eu":r;return await T("cpolar",["authtoken",s]),await T("sh",["-c",`nohup cpolar tcp -region=${n} 22 > ${process.env.HOME}/.openclaw/logs/cpolar.log 2>&1 &`]),e.json({success:!0})}catch(t){return e.json({success:!1,error:"启动远程支持失败: "+(t.message||"未知错误")},500)}});const Y=new Ae;function ne(e){return JSON.stringify(e).replace(/[\u0080-\uffff]/g,t=>"\\u"+t.charCodeAt(0).toString(16).padStart(4,"0"))}function pr(e){return Array.isArray(e)?e:typeof e=="string"&&e?e.split("+").map(t=>t.trim()).filter(Boolean):["text"]}async function ys(){let e=[];try{const{stdout:s}=await T("openclaw",["models","list","--json"]),r=pe(s);r&&Array.isArray(r.models)&&(e=r.models.map(n=>({key:n.key||"unknown",label:`${n.name||n.key} (${(n.key||"").split("/")[0]})`,input:pr(n.input)})))}catch{try{const{stdout:s}=await T("openclaw",["config","get","--json","models.providers"]),r=pe(s)||{};Object.entries(r).forEach(([n,a])=>{(Array.isArray(a==null?void 0:a.models)?a.models:[]).forEach(i=>{const c=(i==null?void 0:i.id)||(i==null?void 0:i.name)||"unknown",d=(i==null?void 0:i.name)||(i==null?void 0:i.id)||c;e.push({key:`${n}/${c}`,label:`${d} (${n})`,input:pr(i==null?void 0:i.input)})})})}catch{}}let t=null;try{const{stdout:s}=await T("openclaw",["config","get","agents.defaults.model.primary"]);t=Ke(s)||null}catch{t=null}return{models:e,defaultModel:t}}const Bo={text:"文本",image:"图片",audio:"音频",video:"视频"};function Go(e){return l("div",{class:`rounded-xl border ${e.isDefault?"border-emerald-300 bg-emerald-50":"border-slate-200 bg-white"} p-4`,children:[l("strong",{class:"text-sm text-slate-700",children:e.model.label}),l("div",{class:"mt-1.5 text-xs text-slate-500",children:e.model.key}),l("div",{class:"mt-2 flex flex-wrap gap-1",children:e.model.input.map(t=>l("span",{class:"inline-flex items-center rounded-full bg-slate-100 px-2 py-0.5 text-[10px] font-medium text-slate-600",children:Bo[t]||t}))}),l("div",{class:"mt-3 flex flex-wrap gap-2",children:l("button",{class:"rounded-lg border border-slate-200 px-3 py-1 text-xs text-slate-600 hover:bg-slate-100 disabled:opacity-50 disabled:cursor-not-allowed","hx-post":"/api/partials/models/default","hx-vals":JSON.stringify({model:e.model.key}),"hx-target":"#model-list","hx-swap":"innerHTML","hx-disabled-elt":"this",children:[l("span",{class:"hx-ready",children:e.isDefault?"✓ 当前默认":"设为默认"}),l("span",{class:"hx-loading items-center gap-1",children:[l("svg",{class:"animate-spin h-3 w-3",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[l("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4"}),l("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"})]}),"切换中…"]})]})})]})}function Os(e){var s;if(!e.models.length)return l("p",{class:"text-sm text-slate-500",children:"暂无已配置模型"});const t=e.defaultModel?((s=e.models.find(r=>r.key===e.defaultModel))==null?void 0:s.label)||e.defaultModel:null;return l(ot,{children:[l("div",{class:"col-span-full mb-1 rounded-xl border border-indigo-100 bg-indigo-50/60 px-4 py-3",children:[l("span",{class:"text-sm text-slate-600",children:"当前默认模型："}),t?l("strong",{class:"text-sm text-indigo-700",children:t}):l("span",{class:"text-sm text-slate-400",children:"未设置"})]}),e.models.map(r=>l(Go,{model:r,isDefault:r.key===e.defaultModel}))]})}Y.get("/models",async e=>{try{const{models:t,defaultModel:s}=await ys();return e.html(l(Os,{models:t,defaultModel:s}))}catch{return e.html(l("p",{class:"text-sm text-red-500",children:"无法读取模型配置"}))}});Y.post("/models/default",async e=>{const s=(await e.req.parseBody()).model;if(!s)return e.html(l("p",{class:"text-sm text-red-500",children:"缺少模型参数"}),400);try{await T("openclaw",["config","set","--json","agents.defaults.model",JSON.stringify({primary:s})]);const{models:r,defaultModel:n}=await ys();return e.header("HX-Trigger",ne({"show-alert":{type:"success",message:"已切换默认模型"}})),e.html(l(Os,{models:r,defaultModel:n}))}catch(r){e.header("HX-Trigger",ne({"show-alert":{type:"error",message:"切换失败: "+r.message}}));try{const{models:n,defaultModel:a}=await ys();return e.html(l(Os,{models:n,defaultModel:a}))}catch{return e.html(l("p",{class:"text-sm text-red-500",children:"切换失败"}),500)}}});const dn=[{id:"telegram",label:"Telegram",description:"通过 Telegram 机器人接收和发送消息"},{id:"whatsapp",label:"WhatsApp",description:"通过 WhatsApp Business 接收和发送消息"}];function Ko(e,t){if(e==="whatsapp"){const s=(t==null?void 0:t.accounts)||{},r=Object.keys(s);return r.length===0?!1:r.some(n=>{var a;return((a=s[n])==null?void 0:a.enabled)!==!1})}return(t==null?void 0:t.enabled)!==!1}function un(e="default"){try{const t=Sn.homedir(),s=U.join(t,".openclaw","credentials","whatsapp",e);return E.existsSync(s)?E.readdirSync(s).filter(n=>!n.startsWith(".")).length>0:!1}catch{return!1}}async function ae(){const{stdout:e}=await T("openclaw",["config","get","--json","channels"]),t=pe(e)||{};return Object.entries(t).map(([s,r])=>{const n=Ko(s,r),a=s==="whatsapp"?un():void 0;return{id:s,label:s.toUpperCase(),enabled:n,linked:a,config:r}})}async function fr(e){try{const{stdout:t}=await T("openclaw",["config","get","--json",`channels.${e}`]);return pe(t)||{}}catch{return{}}}function zo(e){return e.id==="whatsapp"?e.linked?e.enabled?{text:"已链接",badgeCls:"bg-emerald-100 text-emerald-700",cardCls:"border-emerald-200 bg-emerald-50"}:{text:"已关闭",badgeCls:"bg-slate-100 text-slate-500",cardCls:"border-slate-200 bg-white"}:{text:"未链接",badgeCls:"bg-amber-100 text-amber-700",cardCls:"border-amber-200 bg-amber-50/50"}:e.enabled?{text:"已启用",badgeCls:"bg-emerald-100 text-emerald-700",cardCls:"border-emerald-200 bg-emerald-50"}:{text:"已关闭",badgeCls:"bg-slate-100 text-slate-500",cardCls:"border-slate-200 bg-white"}}function oe(e){return e.channels.length?l(ot,{children:e.channels.map(t=>{const s=zo(t),r=t.id==="whatsapp"&&!t.linked;return l("div",{class:`rounded-xl border p-4 ${s.cardCls}`,children:[l("div",{class:"flex items-center justify-between",children:[l("strong",{class:"text-sm text-slate-700",children:t.label}),l("span",{class:`inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium ${s.badgeCls}`,children:s.text})]}),r&&l("p",{class:"mt-2 text-xs text-amber-600",children:"尚未扫描二维码完成链接，请点击下方「添加 WhatsApp」开始配置。"}),l("div",{class:"mt-3 flex flex-wrap gap-2",children:[!r&&l("button",{class:"rounded-lg border border-slate-200 px-3 py-1 text-xs text-slate-600 hover:bg-slate-100","hx-get":`/api/partials/channels/${t.id}/edit`,"hx-target":"#channel-form-area","hx-swap":"innerHTML show:#channel-form-area:top",children:"编辑"}),r?l("button",{class:"rounded-lg border border-emerald-200 px-3 py-1 text-xs text-emerald-600 hover:bg-emerald-50","hx-get":"/api/partials/channels/add/whatsapp","hx-target":"#channel-form-area","hx-swap":"innerHTML show:#channel-form-area:top",children:"扫码链接"}):l("button",{class:`rounded-lg border px-3 py-1 text-xs ${t.enabled?"border-red-200 text-red-600 hover:bg-red-50":"border-emerald-200 text-emerald-600 hover:bg-emerald-50"}`,"hx-post":`/api/partials/channels/${t.id}/toggle`,"hx-target":"#channel-list","hx-swap":"innerHTML","hx-disabled-elt":"this",children:[l("span",{class:"hx-ready",children:t.enabled?"关闭":"启用"}),l("span",{class:"hx-loading items-center gap-1",children:[l("svg",{class:"animate-spin h-3 w-3 inline-block",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[l("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4"}),l("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"})]}),"处理中…"]})]})]})]})})}):l("p",{class:"text-sm text-slate-500",children:"暂无已配置渠道"})}function hn(e){return e.available.length?l("div",{class:"mt-4 flex flex-wrap gap-3",children:e.available.map(t=>l("button",{class:"rounded-lg bg-indigo-500 px-4 py-2 text-sm text-white hover:bg-indigo-400","hx-get":`/api/partials/channels/add/${t.id}`,"hx-target":"#channel-form-area","hx-swap":"innerHTML show:#channel-form-area:top",children:["添加 ",t.label]}))}):l("p",{class:"mt-4 text-sm text-slate-500",children:"所有支持的渠道均已配置"})}Y.get("/channels",async e=>{try{const t=await ae();return e.html(l(oe,{channels:t}))}catch{return e.html(l("p",{class:"text-sm text-red-500",children:"无法读取渠道配置"}))}});Y.get("/channels/available",async e=>{try{const t=await ae(),s=new Set(t.map(n=>n.id)),r=dn.filter(n=>!s.has(n.id));return e.html(l(hn,{available:r}))}catch{return e.html(l("p",{class:"text-sm text-red-500",children:"无法获取可用渠道"}))}});Y.get("/channels/add/:type",async e=>{const t=e.req.param("type");if(t==="telegram"){const s=Is({withTokenInput:!0,inputName:"botToken"});return e.html(l("div",{class:"rounded-2xl border border-indigo-200 bg-indigo-50/50 p-6",children:[l("div",{class:"flex items-center justify-between",children:[l("h4",{class:"text-lg font-semibold text-slate-800",children:"添加 Telegram 渠道"}),l("button",{onclick:"document.getElementById('channel-form-area').innerHTML=''",class:"rounded-lg border border-slate-200 px-3 py-1.5 text-xs text-slate-500 hover:bg-slate-100",children:"✕ 关闭"})]}),l("form",{class:"mt-4","hx-post":"/api/partials/channels/add/telegram","hx-target":"#channel-list","hx-swap":"innerHTML",children:[l("div",{children:s}),l("div",{class:"mt-6",children:[l("label",{class:"mb-2 block text-sm font-medium text-slate-600",children:"Telegram 用户 ID"}),l("input",{type:"text",name:"userId",placeholder:"请输入用户 ID",class:"w-full rounded-xl border border-slate-200 bg-white px-4 py-3 text-sm text-slate-700 focus:border-indigo-400 focus:outline-none"})]}),l("div",{class:"mt-6 flex justify-end gap-3",children:[l("button",{type:"button",onclick:"document.getElementById('channel-form-area').innerHTML=''",class:"rounded-lg border border-slate-200 px-5 py-2 text-sm text-slate-600 hover:bg-slate-100",children:"取消"}),l("button",{type:"submit",class:"rounded-lg bg-indigo-500 px-5 py-2 text-sm text-white hover:bg-indigo-400",children:"添加渠道"})]})]})]}))}return t==="whatsapp"?e.html(l("div",{class:"rounded-2xl border border-indigo-200 bg-indigo-50/50 p-6","x-data":"whatsappLinker",children:[l("div",{class:"flex items-center justify-between",children:[l("h4",{class:"text-lg font-semibold text-slate-800",children:"添加 WhatsApp 渠道"}),l("button",{"x-on:click":"close()",class:"rounded-lg border border-slate-200 px-3 py-1.5 text-xs text-slate-500 hover:bg-slate-100",children:"✕ 关闭"})]}),l("div",{"x-show":"state === 'idle'",class:"mt-4",children:[l("p",{class:"text-sm text-slate-600",children:"通过扫描二维码将 WhatsApp 连接到 OpenClaw。"}),l("div",{class:"mt-3 rounded-xl border border-amber-200 bg-amber-50 px-4 py-3",children:[l("p",{class:"text-sm text-amber-700 font-medium",children:"准备工作"}),l("ul",{class:"mt-1.5 text-sm text-amber-600 list-disc list-inside space-y-1",children:[l("li",{children:"确保 OpenClaw Gateway 已启动运行"}),l("li",{children:"准备好你的手机，打开 WhatsApp"}),l("li",{children:"建议使用备用手机号 + eSIM 注册 WhatsApp"})]})]}),l("div",{class:"mt-6 flex justify-end gap-3",children:[l("button",{type:"button","x-on:click":"close()",class:"rounded-lg border border-slate-200 px-5 py-2 text-sm text-slate-600 hover:bg-slate-100",children:"取消"}),l("button",{type:"button","x-on:click":"startLinking()",class:"rounded-lg bg-emerald-500 px-5 py-2 text-sm text-white hover:bg-emerald-400",children:"开始连接 WhatsApp"})]})]}),l("div",{"x-show":"state === 'loading'","x-cloak":!0,class:"mt-6 flex flex-col items-center py-8",children:[l("div",{class:"h-12 w-12 animate-spin rounded-full border-4 border-slate-200 border-t-indigo-500"}),l("p",{class:"mt-4 text-sm text-slate-600 font-medium","x-text":"loadingStep"}),l("p",{class:"mt-1 text-xs text-slate-400",children:"整个过程可能需要 10-30 秒"})]}),l("div",{"x-show":"state === 'qr'","x-cloak":!0,class:"mt-4",children:[l("div",{class:"flex flex-col items-center",children:[l("div",{class:"rounded-2xl bg-white p-4 shadow-lg",children:l("img",{"x-bind:src":"qrDataUrl",alt:"WhatsApp QR Code",class:"h-64 w-64"})}),l("div",{class:"mt-4 text-center",children:[l("p",{class:"text-sm font-medium text-slate-700",children:"请使用手机扫描上方二维码"}),l("p",{class:"mt-1 text-xs text-slate-500",children:"WhatsApp → 设置 → 已关联的设备 → 关联设备"})]}),l("div",{class:"mt-4 flex items-center gap-2 rounded-xl border border-indigo-100 bg-indigo-50 px-4 py-2.5",children:[l("div",{class:"h-2 w-2 animate-pulse rounded-full bg-indigo-500"}),l("span",{class:"text-sm text-indigo-600",children:"等待扫码中..."})]})]}),l("div",{class:"mt-6 flex justify-center gap-3",children:[l("button",{type:"button","x-on:click":"startLinking()",class:"rounded-lg border border-slate-200 px-4 py-2 text-sm text-slate-600 hover:bg-slate-100",children:"刷新二维码"}),l("button",{type:"button","x-on:click":"close()",class:"rounded-lg border border-slate-200 px-4 py-2 text-sm text-slate-600 hover:bg-slate-100",children:"取消"})]})]}),l("div",{"x-show":"state === 'success'","x-cloak":!0,class:"mt-6 flex flex-col items-center py-8",children:[l("div",{class:"flex h-16 w-16 items-center justify-center rounded-full bg-emerald-100",children:l("svg",{class:"h-8 w-8 text-emerald-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:l("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M5 13l4 4L19 7"})})}),l("p",{class:"mt-4 text-lg font-semibold text-emerald-700",children:"WhatsApp 连接成功！"}),l("p",{class:"mt-1 text-sm text-slate-500",children:"你的 WhatsApp 已链接到 OpenClaw"}),l("button",{type:"button","x-on:click":"close()",class:"mt-6 rounded-lg bg-indigo-500 px-5 py-2 text-sm text-white hover:bg-indigo-400",children:"完成"})]}),l("div",{"x-show":"state === 'error'","x-cloak":!0,class:"mt-4",children:[l("div",{class:"rounded-xl border border-red-200 bg-red-50 px-4 py-3",children:[l("p",{class:"text-sm font-medium text-red-700",children:"连接失败"}),l("p",{class:"mt-1 text-sm text-red-600","x-text":"errorMsg"})]}),l("div",{class:"mt-2 rounded-xl border border-slate-200 bg-slate-50 px-4 py-3",children:[l("p",{class:"text-xs font-medium text-slate-600",children:"排查建议"}),l("ul",{class:"mt-1 text-xs text-slate-500 list-disc list-inside space-y-0.5",children:[l("li",{children:["确认 Gateway 已启动：",l("code",{class:"bg-slate-200 px-1 rounded",children:"pgrep -f 'openclaw.*gateway'"})]}),l("li",{children:"确认 WhatsApp 渠道插件已安装"}),l("li",{children:["查看 Gateway 日志：",l("code",{class:"bg-slate-200 px-1 rounded",children:"tail -f ~/.openclaw/logs/gateway.log"})]})]})]}),l("div",{class:"mt-6 flex justify-end gap-3",children:[l("button",{type:"button","x-on:click":"close()",class:"rounded-lg border border-slate-200 px-5 py-2 text-sm text-slate-600 hover:bg-slate-100",children:"取消"}),l("button",{type:"button","x-on:click":"startLinking()",class:"rounded-lg bg-indigo-500 px-5 py-2 text-sm text-white hover:bg-indigo-400",children:"重试"})]})]})]})):e.html(l("p",{class:"text-sm text-red-500",children:"不支持的渠道类型"}),400)});Y.post("/channels/add/telegram",async e=>{try{const t=await e.req.parseBody(),s=(t.botToken||"").trim(),r=(t.userId||"").trim();if(!s||!r){e.header("HX-Trigger",ne({"show-alert":{type:"error",message:"请填写 Bot Token 和用户 ID"}}));const c=await ae();return e.html(l(oe,{channels:c}))}await T("openclaw",["config","set","--json","channels.telegram.botToken",JSON.stringify(s)]),await T("openclaw",["config","set","--json","channels.telegram.allowFrom",JSON.stringify([r])]);try{await T("pkill",["-f","openclaw.*gateway"]),await new Promise(c=>setTimeout(c,2e3))}catch{}const n=`${process.env.HOME}/.openclaw/logs/gateway.log`;T("sh",["-c",`nohup openclaw gateway run --bind loopback --port 18789 > ${n} 2>&1 &`]),await new Promise(c=>setTimeout(c,3e3));const a=await ae(),o=new Set(a.map(c=>c.id)),i=dn.filter(c=>!o.has(c.id));return e.header("HX-Trigger",ne({"show-alert":{type:"success",message:"Telegram 渠道配置成功！"}})),e.html(l(ot,{children:[l(oe,{channels:a}),l("div",{id:"channel-form-area","hx-swap-oob":"innerHTML"}),l("div",{id:"available-channels","hx-swap-oob":"innerHTML",children:l(hn,{available:i})})]}))}catch(t){e.header("HX-Trigger",ne({"show-alert":{type:"error",message:"配置失败: "+t.message}}));try{const s=await ae();return e.html(l(oe,{channels:s}))}catch{return e.html(l("p",{class:"text-sm text-red-500",children:"配置失败"}),500)}}});Y.get("/channels/:id/edit",async e=>{const t=e.req.param("id");if(t==="telegram"){const s=await fr("telegram"),r=s.botToken||"",n=Array.isArray(s.allowFrom)&&s.allowFrom[0]||"",a=Is({withTokenInput:!1});return e.html(l("div",{class:"rounded-2xl border border-indigo-200 bg-indigo-50/50 p-6",children:[l("div",{class:"flex items-center justify-between",children:[l("h4",{class:"text-lg font-semibold text-slate-800",children:"编辑 Telegram 渠道"}),l("button",{onclick:"document.getElementById('channel-form-area').innerHTML=''",class:"rounded-lg border border-slate-200 px-3 py-1.5 text-xs text-slate-500 hover:bg-slate-100",children:"✕ 关闭"})]}),l("form",{class:"mt-4","hx-post":"/api/partials/channels/telegram/save","hx-target":"#channel-list","hx-swap":"innerHTML",children:[l("details",{class:"mt-2",children:[l("summary",{class:"cursor-pointer text-sm font-medium text-indigo-600 hover:text-indigo-500",children:"查看配置指南"}),l("div",{class:"mt-2",children:a})]}),l("div",{class:"mt-6",children:[l("label",{class:"mb-2 block text-sm font-medium text-slate-600",children:"Telegram Bot Token"}),l("input",{type:"text",name:"botToken",value:r,placeholder:"请输入 Bot Token",class:"w-full rounded-xl border border-slate-200 bg-white px-4 py-3 text-sm text-slate-700 focus:border-indigo-400 focus:outline-none"})]}),l("div",{class:"mt-4",children:[l("label",{class:"mb-2 block text-sm font-medium text-slate-600",children:"Telegram 用户 ID"}),l("input",{type:"text",name:"userId",value:n,placeholder:"请输入用户 ID",class:"w-full rounded-xl border border-slate-200 bg-white px-4 py-3 text-sm text-slate-700 focus:border-indigo-400 focus:outline-none"})]}),l("div",{class:"mt-6 flex justify-end gap-3",children:[l("button",{type:"button",onclick:"document.getElementById('channel-form-area').innerHTML=''",class:"rounded-lg border border-slate-200 px-5 py-2 text-sm text-slate-600 hover:bg-slate-100",children:"取消"}),l("button",{type:"submit",class:"rounded-lg bg-indigo-500 px-5 py-2 text-sm text-white hover:bg-indigo-400",children:"保存修改"})]})]})]}))}if(t==="whatsapp"){const s=await fr("whatsapp"),r=un();return e.html(l("div",{class:"rounded-2xl border border-indigo-200 bg-indigo-50/50 p-6","x-data":"whatsappLinker",children:[l("div",{class:"flex items-center justify-between",children:[l("h4",{class:"text-lg font-semibold text-slate-800",children:"WhatsApp 渠道管理"}),l("button",{"x-on:click":"close()",class:"rounded-lg border border-slate-200 px-3 py-1.5 text-xs text-slate-500 hover:bg-slate-100",children:"✕ 关闭"})]}),l("div",{class:"mt-4 rounded-xl border border-slate-200 bg-white px-4 py-3",children:[l("div",{class:"flex items-center justify-between",children:[l("span",{class:"text-sm text-slate-600",children:"链接状态"}),l("span",{class:`inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium ${r?"bg-emerald-100 text-emerald-700":"bg-amber-100 text-amber-700"}`,children:r?"已链接":"未链接"})]}),s.dmPolicy&&l("div",{class:"mt-2 flex items-center justify-between",children:[l("span",{class:"text-sm text-slate-600",children:"DM 策略"}),l("span",{class:"text-sm text-slate-800",children:s.dmPolicy})]}),Array.isArray(s.allowFrom)&&s.allowFrom.length>0&&l("div",{class:"mt-2 flex items-center justify-between",children:[l("span",{class:"text-sm text-slate-600",children:"允许号码"}),l("span",{class:"text-sm text-slate-800",children:s.allowFrom.join(", ")})]})]}),l("div",{"x-show":"state === 'idle'",class:"mt-4",children:[l("p",{class:"text-sm text-slate-500",children:r?"如需更换手机号或重新绑定，可点击下方按钮生成新的二维码。":"尚未完成链接，请扫描二维码绑定 WhatsApp。"}),l("div",{class:"mt-6 flex justify-end gap-3",children:[l("button",{type:"button","x-on:click":"close()",class:"rounded-lg border border-slate-200 px-5 py-2 text-sm text-slate-600 hover:bg-slate-100",children:"取消"}),l("button",{type:"button","x-on:click":"startLinking()",class:"rounded-lg bg-emerald-500 px-5 py-2 text-sm text-white hover:bg-emerald-400",children:r?"重新链接":"扫码链接"})]})]}),l("div",{"x-show":"state === 'loading'","x-cloak":!0,class:"mt-6 flex flex-col items-center py-8",children:[l("div",{class:"h-12 w-12 animate-spin rounded-full border-4 border-slate-200 border-t-indigo-500"}),l("p",{class:"mt-4 text-sm text-slate-600 font-medium","x-text":"loadingStep"}),l("p",{class:"mt-1 text-xs text-slate-400",children:"整个过程可能需要 10-30 秒"})]}),l("div",{"x-show":"state === 'qr'","x-cloak":!0,class:"mt-4",children:[l("div",{class:"flex flex-col items-center",children:[l("div",{class:"rounded-2xl bg-white p-4 shadow-lg",children:l("img",{"x-bind:src":"qrDataUrl",alt:"WhatsApp QR Code",class:"h-64 w-64"})}),l("div",{class:"mt-4 text-center",children:[l("p",{class:"text-sm font-medium text-slate-700",children:"请使用手机扫描上方二维码"}),l("p",{class:"mt-1 text-xs text-slate-500",children:"WhatsApp → 设置 → 已关联的设备 → 关联设备"})]}),l("div",{class:"mt-4 flex items-center gap-2 rounded-xl border border-indigo-100 bg-indigo-50 px-4 py-2.5",children:[l("div",{class:"h-2 w-2 animate-pulse rounded-full bg-indigo-500"}),l("span",{class:"text-sm text-indigo-600",children:"等待扫码中..."})]})]}),l("div",{class:"mt-6 flex justify-center gap-3",children:[l("button",{type:"button","x-on:click":"startLinking()",class:"rounded-lg border border-slate-200 px-4 py-2 text-sm text-slate-600 hover:bg-slate-100",children:"刷新二维码"}),l("button",{type:"button","x-on:click":"close()",class:"rounded-lg border border-slate-200 px-4 py-2 text-sm text-slate-600 hover:bg-slate-100",children:"取消"})]})]}),l("div",{"x-show":"state === 'success'","x-cloak":!0,class:"mt-6 flex flex-col items-center py-8",children:[l("div",{class:"flex h-16 w-16 items-center justify-center rounded-full bg-emerald-100",children:l("svg",{class:"h-8 w-8 text-emerald-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:l("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M5 13l4 4L19 7"})})}),l("p",{class:"mt-4 text-lg font-semibold text-emerald-700",children:"WhatsApp 链接成功！"}),l("p",{class:"mt-1 text-sm text-slate-500",children:"你的 WhatsApp 已链接到 OpenClaw"}),l("button",{type:"button","x-on:click":"close()",class:"mt-6 rounded-lg bg-indigo-500 px-5 py-2 text-sm text-white hover:bg-indigo-400",children:"完成"})]}),l("div",{"x-show":"state === 'error'","x-cloak":!0,class:"mt-4",children:[l("div",{class:"rounded-xl border border-red-200 bg-red-50 px-4 py-3",children:[l("p",{class:"text-sm font-medium text-red-700",children:"连接失败"}),l("p",{class:"mt-1 text-sm text-red-600","x-text":"errorMsg"})]}),l("div",{class:"mt-6 flex justify-end gap-3",children:[l("button",{type:"button","x-on:click":"close()",class:"rounded-lg border border-slate-200 px-5 py-2 text-sm text-slate-600 hover:bg-slate-100",children:"取消"}),l("button",{type:"button","x-on:click":"startLinking()",class:"rounded-lg bg-indigo-500 px-5 py-2 text-sm text-white hover:bg-indigo-400",children:"重试"})]})]})]}))}return e.html(l("p",{class:"text-sm text-red-500",children:"不支持编辑此渠道"}),400)});Y.post("/channels/:id/save",async e=>{if(e.req.param("id")!=="telegram")return e.html(l("p",{class:"text-sm text-red-500",children:"不支持编辑此渠道"}),400);try{const s=await e.req.parseBody(),r=(s.botToken||"").trim(),n=(s.userId||"").trim();if(!r||!n){e.header("HX-Trigger",ne({"show-alert":{type:"error",message:"请填写 Bot Token 和用户 ID"}}));const i=await ae();return e.html(l(oe,{channels:i}))}await T("openclaw",["config","set","--json","channels.telegram.botToken",JSON.stringify(r)]),await T("openclaw",["config","set","--json","channels.telegram.allowFrom",JSON.stringify([n])]);try{await T("pkill",["-f","openclaw.*gateway"]),await new Promise(i=>setTimeout(i,2e3))}catch{}const a=`${process.env.HOME}/.openclaw/logs/gateway.log`;T("sh",["-c",`nohup openclaw gateway run --bind loopback --port 18789 > ${a} 2>&1 &`]),await new Promise(i=>setTimeout(i,3e3));const o=await ae();return e.header("HX-Trigger",ne({"show-alert":{type:"success",message:"Telegram 渠道已更新"}})),e.html(l(ot,{children:[l(oe,{channels:o}),l("div",{id:"channel-form-area","hx-swap-oob":"innerHTML"})]}))}catch(s){e.header("HX-Trigger",ne({"show-alert":{type:"error",message:"保存失败: "+s.message}}));try{const r=await ae();return e.html(l(oe,{channels:r}))}catch{return e.html(l("p",{class:"text-sm text-red-500",children:"保存失败"}),500)}}});Y.post("/channels/:id/toggle",async e=>{var s;const t=e.req.param("id");try{const r=await ae(),n=r.find(c=>c.id===t);if(!n)return e.header("HX-Trigger",ne({"show-alert":{type:"error",message:"渠道不存在"}})),e.html(l(oe,{channels:r}));const a=!n.enabled;if(t==="whatsapp"){const c=((s=n.config)==null?void 0:s.accounts)||{},d=Object.keys(c),u=d.length>0?d[0]:"default";await T("openclaw",["config","set","--json",`channels.whatsapp.accounts.${u}.enabled`,String(a)])}else await T("openclaw",["config","set",`channels.${t}.enabled`,String(a)]);try{await T("pkill",["-f","openclaw.*gateway"]),await new Promise(c=>setTimeout(c,2e3))}catch{}const o=`${process.env.HOME}/.openclaw/logs/gateway.log`;T("sh",["-c",`nohup openclaw gateway run --bind loopback --port 18789 > ${o} 2>&1 &`]),await new Promise(c=>setTimeout(c,3e3));const i=await ae();return e.header("HX-Trigger",ne({"show-alert":{type:"success",message:`${n.label} 已${a?"启用":"关闭"}`}})),e.html(l(oe,{channels:i}))}catch(r){e.header("HX-Trigger",ne({"show-alert":{type:"error",message:"操作失败: "+r.message}}));try{const n=await ae();return e.html(l(oe,{channels:n}))}catch{return e.html(l("p",{class:"text-sm text-red-500",children:"操作失败"}),500)}}});function Ns(){const e=process.env.HOME||process.cwd();return U.join(e,".openclaw-helper","remote-support.json")}Y.get("/remote-support/form",async e=>{let t={sshKey:"",cpolarToken:"",region:"en"};try{const r=Ns();E.existsSync(r)&&(t={...t,...JSON.parse(E.readFileSync(r,"utf-8"))})}catch{}const s=JSON.stringify({sshKey:t.sshKey||"",cpolarToken:t.cpolarToken||"",region:t.region||"en"});return e.html(l("form",{"x-data":s,id:"remote-form-inner",children:[l("div",{class:"mt-4",children:[l("label",{for:"ssh-key",class:"mb-2 block text-sm font-medium text-slate-600",children:"SSH Key"}),l("textarea",{id:"ssh-key",name:"sshKey",rows:4,"x-model":"sshKey",placeholder:"粘贴 SSH 公钥",class:"w-full rounded-xl border border-slate-200 bg-white px-4 py-3 text-sm text-slate-700 focus:border-indigo-400 focus:outline-none"})]}),l("div",{class:"mt-4",children:[l("label",{for:"cpolar-token",class:"mb-2 block text-sm font-medium text-slate-600",children:"cpolar AuthToken"}),l("input",{type:"text",id:"cpolar-token",name:"cpolarToken","x-model":"cpolarToken",placeholder:"输入 cpolar Authtoken",class:"w-full rounded-xl border border-slate-200 bg-white px-4 py-3 text-sm text-slate-700 focus:border-indigo-400 focus:outline-none"})]}),l("div",{class:"mt-4",children:[l("label",{for:"region-select",class:"mb-2 block text-sm font-medium text-slate-600",children:"区域"}),l("select",{id:"region-select",name:"region","x-model":"region",class:"w-full rounded-xl border border-slate-200 bg-white px-4 py-3 text-sm text-slate-700 focus:border-indigo-400 focus:outline-none",children:[l("option",{value:"cn",children:"中国 (cn)"}),l("option",{value:"uk",children:"美国 (uk)"}),l("option",{value:"en",children:"欧洲 (en)"})]})]}),l("div",{class:"mt-6 flex flex-wrap gap-3",id:"remote-alert"}),l("div",{class:"mt-4 flex flex-wrap gap-3",children:[l("button",{type:"button","hx-post":"/api/partials/remote-support/save","hx-include":"#remote-form-inner","hx-target":"#remote-alert","hx-swap":"innerHTML",class:"rounded-lg border border-slate-200 px-4 py-2 text-sm text-slate-600 hover:bg-slate-100",children:"保存配置"}),l("button",{type:"button","hx-post":"/api/partials/remote-support/start","hx-include":"#remote-form-inner","hx-target":"#remote-alert","hx-swap":"innerHTML","x-bind":"{ disabled: !sshKey.trim() || !cpolarToken.trim() }",class:"rounded-lg bg-indigo-500 px-4 py-2 text-sm text-white hover:bg-indigo-400 disabled:bg-slate-200 disabled:text-slate-400",children:"打开远程支持"})]})]}))});Y.post("/remote-support/save",async e=>{try{const t=await e.req.parseBody(),s=Ns(),r=U.dirname(s);return E.existsSync(r)||E.mkdirSync(r,{recursive:!0}),E.writeFileSync(s,JSON.stringify({sshKey:t.sshKey||"",cpolarToken:t.cpolarToken||"",region:t.region||"en"},null,2)),e.html(l("div",{class:"rounded-xl border border-emerald-200 bg-emerald-50 px-4 py-3 text-sm text-emerald-700",children:"已保存远程支持配置"}))}catch(t){return e.html(l("div",{class:"rounded-xl border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700",children:["保存失败: ",t.message]}))}});Y.post("/remote-support/start",async e=>{try{const t=await e.req.parseBody(),s=(t.sshKey||"").trim(),r=(t.cpolarToken||"").trim(),n=t.region||"en";if(!s||!r)return e.html(l("div",{class:"rounded-xl border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700",children:"请填写 SSH Key 和 cpolar AuthToken"}));const a=Ns(),o=U.dirname(a);E.existsSync(o)||E.mkdirSync(o,{recursive:!0}),E.writeFileSync(a,JSON.stringify({sshKey:s,cpolarToken:r,region:n},null,2));const i=n==="en"?"eu":n;return await T("cpolar",["authtoken",r]),await T("sh",["-c",`nohup cpolar tcp -region=${i} 22 > ${process.env.HOME}/.openclaw/logs/cpolar.log 2>&1 &`]),e.html(l("div",{class:"rounded-xl border border-emerald-200 bg-emerald-50 px-4 py-3 text-sm text-emerald-700",children:"远程支持已启动"}))}catch(t){return e.html(l("div",{class:"rounded-xl border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700",children:["启动失败: ",t.message]}))}});const St=new Ae;St.use("/*",ko());St.route("/api/config",B);St.route("/api/partials",Y);St.get("/health",e=>e.json({status:"ok",timestamp:new Date().toISOString()}));const Jo=Ao({app:St});var Qo=(e,t=Vo)=>{const s=/\.([a-zA-Z0-9]+?)$/,r=e.match(s);if(!r)return;let n=t[r[1]];return n&&n.startsWith("text")&&(n+="; charset=utf-8"),n},Xo={aac:"audio/aac",avi:"video/x-msvideo",avif:"image/avif",av1:"video/av1",bin:"application/octet-stream",bmp:"image/bmp",css:"text/css",csv:"text/csv",eot:"application/vnd.ms-fontobject",epub:"application/epub+zip",gif:"image/gif",gz:"application/gzip",htm:"text/html",html:"text/html",ico:"image/x-icon",ics:"text/calendar",jpeg:"image/jpeg",jpg:"image/jpeg",js:"text/javascript",json:"application/json",jsonld:"application/ld+json",map:"application/json",mid:"audio/x-midi",midi:"audio/x-midi",mjs:"text/javascript",mp3:"audio/mpeg",mp4:"video/mp4",mpeg:"video/mpeg",oga:"audio/ogg",ogv:"video/ogg",ogx:"application/ogg",opus:"audio/opus",otf:"font/otf",pdf:"application/pdf",png:"image/png",rtf:"application/rtf",svg:"image/svg+xml",tif:"image/tiff",tiff:"image/tiff",ts:"video/mp2t",ttf:"font/ttf",txt:"text/plain",wasm:"application/wasm",webm:"video/webm",weba:"audio/webm",webmanifest:"application/manifest+json",webp:"image/webp",woff:"font/woff",woff2:"font/woff2",xhtml:"application/xhtml+xml",xml:"application/xml",zip:"application/zip","3gp":"video/3gpp","3g2":"video/3gpp2",gltf:"model/gltf+json",glb:"model/gltf-binary"},Vo=Xo,Yo=/^\s*(?:text\/[^;\s]+|application\/(?:javascript|json|xml|xml-dtd|ecmascript|dart|postscript|rtf|tar|toml|vnd\.dart|vnd\.ms-fontobject|vnd\.ms-opentype|wasm|x-httpd-php|x-javascript|x-ns-proxy-autoconfig|x-sh|x-tar|x-virtualbox-hdd|x-virtualbox-ova|x-virtualbox-ovf|x-virtualbox-vbox|x-virtualbox-vdi|x-virtualbox-vhd|x-virtualbox-vmdk|x-www-form-urlencoded)|font\/(?:otf|ttf)|image\/(?:bmp|vnd\.adobe\.photoshop|vnd\.microsoft\.icon|vnd\.ms-dds|x-icon|x-ms-bmp)|message\/rfc822|model\/gltf-binary|x-shader\/x-fragment|x-shader\/x-vertex|[^;\s]+?\+(?:json|text|xml|yaml))(?:[;\s]|$)/i,Ts={br:".br",zstd:".zst",gzip:".gz"},Zo=Object.keys(Ts),ei=()=>{const[e,t]=Cn.node.split(".").map(s=>parseInt(s));return e>=23||e===22&&t>=7||e===20&&t>=18},ti=ei(),mr=e=>ti?fs.toWeb(e):new ReadableStream({start(s){e.on("data",r=>{s.enqueue(r)}),e.on("error",r=>{s.error(r)}),e.on("end",()=>{s.close()})},cancel(){e.destroy()}}),us=e=>{let t;try{t=Rn(e)}catch{}return t},Hs=(e={root:""})=>{const t=e.root||"",s=e.path;return t!==""&&!jn(t)&&console.error(`serveStatic: root path '${t}' is not found, are you sure it's correct?`),async(r,n)=>{var f,m,w,v;if(r.finalized)return n();let a;if(s)a=s;else try{if(a=decodeURIComponent(r.req.path),/(?:^|[\/\\])\.\.(?:$|[\/\\])/.test(a))throw new Error}catch{return await((f=e.onNotFound)==null?void 0:f.call(e,r.req.path,r)),n()}let o=Gs(t,!s&&e.rewriteRequestPath?e.rewriteRequestPath(a,r):a),i=us(o);if(i&&i.isDirectory()){const g=e.index??"index.html";o=Gs(o,g),i=us(o)}if(!i)return await((m=e.onNotFound)==null?void 0:m.call(e,o,r)),n();const c=Qo(o);if(r.header("Content-Type",c||"application/octet-stream"),e.precompressed&&(!c||Yo.test(c))){const g=new Set((w=r.req.header("Accept-Encoding"))==null?void 0:w.split(",").map(b=>b.trim()));for(const b of Zo){if(!g.has(b))continue;const O=us(o+Ts[b]);if(O){r.header("Content-Encoding",b),r.header("Vary","Accept-Encoding",{append:!0}),i=O,o=o+Ts[b];break}}}let d;const u=i.size,p=r.req.header("range")||"";if(r.req.method=="HEAD"||r.req.method=="OPTIONS")r.header("Content-Length",u.toString()),r.status(200),d=r.body(null);else if(!p)r.header("Content-Length",u.toString()),d=r.body(mr(Bs(o)),200);else{r.header("Accept-Ranges","bytes"),r.header("Date",i.birthtime.toUTCString());const g=p.replace(/bytes=/,"").split("-",2),b=parseInt(g[0],10)||0;let O=parseInt(g[1],10)||u-1;u<O-b+1&&(O=u-1);const S=O-b+1,k=Bs(o,{start:b,end:O});r.header("Content-Length",S.toString()),r.header("Content-Range",`bytes ${b}-${O}/${i.size}`),d=r.body(mr(k),206)}return await((v=e.onFound)==null?void 0:v.call(e,o,r)),d}},je=class extends Error{constructor(e,t){super(e,t),this.name="RequestError"}},si=e=>e instanceof je?e:new je(e.message,{cause:e}),ri=global.Request,mt=class extends ri{constructor(t,s){var r;typeof t=="object"&&rt in t&&(t=t[rt]()),typeof((r=s==null?void 0:s.body)==null?void 0:r.getReader)<"u"&&(s.duplex??(s.duplex="half")),super(t,s)}},ni=e=>{const t=[],s=e.rawHeaders;for(let r=0;r<s.length;r+=2){const{[r]:n,[r+1]:a}=s;n.charCodeAt(0)!==58&&t.push([n,a])}return new Headers(t)},pn=Symbol("wrapBodyStream"),ai=(e,t,s,r,n)=>{const a={method:e,headers:s,signal:n.signal};if(e==="TRACE"){a.method="GET";const o=new mt(t,a);return Object.defineProperty(o,"method",{get(){return"TRACE"}}),o}if(!(e==="GET"||e==="HEAD"))if("rawBody"in r&&r.rawBody instanceof Buffer)a.body=new ReadableStream({start(o){o.enqueue(r.rawBody),o.close()}});else if(r[pn]){let o;a.body=new ReadableStream({async pull(i){try{o||(o=fs.toWeb(r).getReader());const{done:c,value:d}=await o.read();c?i.close():i.enqueue(d)}catch(c){i.error(c)}}})}else a.body=fs.toWeb(r);return new mt(t,a)},rt=Symbol("getRequestCache"),hs=Symbol("requestCache"),Wt=Symbol("incomingKey"),zt=Symbol("urlKey"),ps=Symbol("headersKey"),me=Symbol("abortControllerKey"),oi=Symbol("getAbortController"),Xt={get method(){return this[Wt].method||"GET"},get url(){return this[zt]},get headers(){return this[ps]||(this[ps]=ni(this[Wt]))},[oi](){return this[rt](),this[me]},[rt](){return this[me]||(this[me]=new AbortController),this[hs]||(this[hs]=ai(this.method,this[zt],this.headers,this[Wt],this[me]))}};["body","bodyUsed","cache","credentials","destination","integrity","mode","redirect","referrer","referrerPolicy","signal","keepalive"].forEach(e=>{Object.defineProperty(Xt,e,{get(){return this[rt]()[e]}})});["arrayBuffer","blob","clone","formData","json","text"].forEach(e=>{Object.defineProperty(Xt,e,{value:function(){return this[rt]()[e]()}})});Object.setPrototypeOf(Xt,mt.prototype);var ii=(e,t)=>{const s=Object.create(Xt);s[Wt]=e;const r=e.url||"";if(r[0]!=="/"&&(r.startsWith("http://")||r.startsWith("https://"))){if(e instanceof Mt)throw new je("Absolute URL for :path is not allowed in HTTP/2");try{const i=new URL(r);s[zt]=i.href}catch(i){throw new je("Invalid absolute URL",{cause:i})}return s}const n=(e instanceof Mt?e.authority:e.headers.host)||t;if(!n)throw new je("Missing host header");let a;if(e instanceof Mt){if(a=e.scheme,!(a==="http"||a==="https"))throw new je("Unsupported scheme")}else a=e.socket&&e.socket.encrypted?"https":"http";const o=new URL(`${a}://${n}${r}`);if(o.hostname.length!==n.length&&o.hostname!==n.replace(/:\d+$/,""))throw new je("Invalid host header");return s[zt]=o.href,s},_t=Symbol("responseCache"),Ge=Symbol("getResponseCache"),Re=Symbol("cache"),Ls=global.Response,Ot,he,et,jt=(et=class{constructor(t,s){A(this,Ot);A(this,he);let r;if(y(this,Ot,t),s instanceof et){const n=s[_t];if(n){y(this,he,n),this[Ge]();return}else y(this,he,h(s,he)),r=new Headers(h(s,he).headers)}else y(this,he,s);(typeof t=="string"||typeof(t==null?void 0:t.getReader)<"u"||t instanceof Blob||t instanceof Uint8Array)&&(r||(r=(s==null?void 0:s.headers)||{"content-type":"text/plain; charset=UTF-8"}),this[Re]=[(s==null?void 0:s.status)||200,t,r])}[Ge](){return delete this[Re],this[_t]||(this[_t]=new Ls(h(this,Ot),h(this,he)))}get headers(){const t=this[Re];return t?(t[2]instanceof Headers||(t[2]=new Headers(t[2])),t[2]):this[Ge]().headers}get status(){var t;return((t=this[Re])==null?void 0:t[0])??this[Ge]().status}get ok(){const t=this.status;return t>=200&&t<300}},Ot=new WeakMap,he=new WeakMap,et);["body","bodyUsed","redirected","statusText","trailers","type","url"].forEach(e=>{Object.defineProperty(jt.prototype,e,{get(){return this[Ge]()[e]}})});["arrayBuffer","blob","clone","formData","json","text"].forEach(e=>{Object.defineProperty(jt.prototype,e,{value:function(){return this[Ge]()[e]()}})});Object.setPrototypeOf(jt,Ls);Object.setPrototypeOf(jt.prototype,Ls.prototype);async function li(e){return Promise.race([e,Promise.resolve().then(()=>Promise.resolve(void 0))])}function fn(e,t,s){const r=i=>{e.cancel(i).catch(()=>{})};return t.on("close",r),t.on("error",r),(s??e.read()).then(o,n),e.closed.finally(()=>{t.off("close",r),t.off("error",r)});function n(i){i&&t.destroy(i)}function a(){e.read().then(o,n)}function o({done:i,value:c}){try{if(i)t.end();else if(!t.write(c))t.once("drain",a);else return e.read().then(o,n)}catch(d){n(d)}}}function ci(e,t){if(e.locked)throw new TypeError("ReadableStream is locked.");return t.destroyed?void 0:fn(e.getReader(),t)}var mn=e=>{const t={};e instanceof Headers||(e=new Headers(e??void 0));const s=[];for(const[r,n]of e)r==="set-cookie"?s.push(n):t[r]=n;return s.length>0&&(t["set-cookie"]=s),t["content-type"]??(t["content-type"]="text/plain; charset=UTF-8"),t},di="x-hono-already-sent";typeof global.crypto>"u"&&(global.crypto=_n);var $s=Symbol("outgoingEnded"),ui=()=>new Response(null,{status:400}),gn=e=>new Response(null,{status:e instanceof Error&&(e.name==="TimeoutError"||e.constructor.name==="TimeoutError")?504:500}),As=(e,t)=>{const s=e instanceof Error?e:new Error("unknown error",{cause:e});s.code==="ERR_STREAM_PREMATURE_CLOSE"?console.info("The user aborted a request."):(console.error(e),t.headersSent||t.writeHead(500,{"Content-Type":"text/plain"}),t.end(`Error: ${s.message}`),t.destroy(s))},xn=e=>{"flushHeaders"in e&&e.writable&&e.flushHeaders()},wn=async(e,t)=>{var a,o;let[s,r,n]=e[Re];n instanceof Headers&&(n=mn(n)),typeof r=="string"?n["Content-Length"]=Buffer.byteLength(r):r instanceof Uint8Array?n["Content-Length"]=r.byteLength:r instanceof Blob&&(n["Content-Length"]=r.size),t.writeHead(s,n),typeof r=="string"||r instanceof Uint8Array?t.end(r):r instanceof Blob?t.end(new Uint8Array(await r.arrayBuffer())):(xn(t),await((a=ci(r,t))==null?void 0:a.catch(i=>As(i,t)))),(o=t[$s])==null||o.call(t)},hi=e=>typeof e.then=="function",pi=async(e,t,s={})=>{var n;if(hi(e))if(s.errorHandler)try{e=await e}catch(a){const o=await s.errorHandler(a);if(!o)return;e=o}else e=await e.catch(gn);if(Re in e)return wn(e,t);const r=mn(e.headers);if(e.body){const a=e.body.getReader(),o=[];let i=!1,c;if(r["transfer-encoding"]!=="chunked"){let d=2;for(let u=0;u<d;u++){c||(c=a.read());const p=await li(c).catch(f=>{console.error(f),i=!0});if(!p){if(u===1){await new Promise(f=>setTimeout(f)),d=3;continue}break}if(c=void 0,p.value&&o.push(p.value),p.done){i=!0;break}}i&&!("content-length"in r)&&(r["content-length"]=o.reduce((u,p)=>u+p.length,0))}t.writeHead(e.status,r),o.forEach(d=>{t.write(d)}),i?t.end():(o.length===0&&xn(t),await fn(a,t,c))}else r[di]||(t.writeHead(e.status,r),t.end());(n=t[$s])==null||n.call(t)},fi=(e,t={})=>{const s=t.autoCleanupIncoming??!0;return t.overrideGlobalObjects!==!1&&global.Request!==mt&&(Object.defineProperty(global,"Request",{value:mt}),Object.defineProperty(global,"Response",{value:jt})),async(r,n)=>{let a,o;try{o=ii(r,t.hostname);let i=!s||r.method==="GET"||r.method==="HEAD";if(i||(r[pn]=!0,r.on("end",()=>{i=!0}),r instanceof Mt&&(n[$s]=()=>{i||setTimeout(()=>{i||setTimeout(()=>{r.destroy(),n.destroy()})})})),n.on("close",()=>{o[me]&&(r.errored?o[me].abort(r.errored.toString()):n.writableFinished||o[me].abort("Client connection prematurely closed.")),i||setTimeout(()=>{i||setTimeout(()=>{r.destroy()})})}),a=e(o,{incoming:r,outgoing:n}),Re in a)return wn(a,n)}catch(i){if(a)return As(i,n);if(t.errorHandler){if(a=await t.errorHandler(o?i:si(i)),!a)return}else o?a=gn(i):a=ui()}try{return await pi(a,n,t)}catch(i){return As(i,n)}}},mi=e=>{const t=e.fetch,s=fi(t,{hostname:e.hostname,overrideGlobalObjects:e.overrideGlobalObjects,autoCleanupIncoming:e.autoCleanupIncoming});return(e.createServer||Pn)(e.serverOptions||{},s)},gi=(e,t)=>{const s=mi(e);return s.listen(e==null?void 0:e.port,e.hostname,()=>{s.address()}),s};const nt=new Ae;nt.use("/assets/*",Hs({root:"./"}));nt.use("/tailwind.css",Hs({root:"./"}));nt.use("/index.html",Hs({root:"./"}));const xi=Object.assign({"/app/server.ts":Jo});let bn=!1;for(const[,e]of Object.entries(xi))e&&(nt.all("*",t=>{let s;try{s=t.executionCtx}catch{}return e.fetch(t.req.raw,t.env,s)}),nt.notFound(t=>{let s;try{s=t.executionCtx}catch{}return e.fetch(t.req.raw,t.env,s)}),bn=!0);if(!bn)throw new Error("Can't import modules from ['/app/server.ts']");gi({fetch:nt.fetch,port:17543});export{nt as default};
